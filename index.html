<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>××¨×’×•×Ÿ ×•×¡×“×¨ â€“ ×”×‘×™×ª ×©×œ ×¡×˜×¤× ×™</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Heebo',sans-serif}
    .glass{backdrop-filter:blur(10px);background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.7))}
    .card{border-radius:18px;box-shadow:0 10px 30px rgba(31,41,55,.08)}
    .btn{transition:.15s}
    .btn:active{transform:translateY(1px)}
    .chip{background:rgba(124,58,237,.08);color:#6d28d9}
    .ring-progress{transform:rotate(-90deg)}
    .toast{position:fixed;bottom:18px;right:18px;z-index:9999}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-purple-50 via-pink-50 to-rose-50">

  <!-- Header -->
  <header class="sticky top-0 z-10 bg-white/70 backdrop-blur border-b border-purple-100">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <h1 class="text-xl sm:text-2xl font-extrabold text-purple-700">âœ¨ ××¨×’×•×Ÿ ×•×¡×“×¨</h1>
      <nav class="flex gap-2">
        <button id="tab-home" class="btn px-3 py-2 rounded-lg bg-purple-600 text-white">×‘×™×ª</button>
        <button id="tab-dash" class="btn px-3 py-2 rounded-lg hover:bg-purple-100 text-purple-700">×“×©×‘×•×¨×“</button>
      </nav>
    </div>
  </header>

  <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">

    <!-- ====== HOME VIEW ====== -->
    <section id="view-home" class="space-y-6">

      <!-- Summary / Progress -->
      <div class="card glass p-4 sm:p-6">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-lg font-bold text-gray-800 mb-1">×”×™×•× â€¢ <span id="today-label" class="text-purple-700"></span></h2>
            <p class="text-sm text-gray-600">××©×™××•×ª ×§×¦×¨×•×ª ×œ×™ ×•×œ×‘× ×•×ª + ××™×§×•×“ ×œ×¤×™ ××–×•×¨</p>
          </div>
          <div class="relative w-16 h-16">
            <svg viewBox="0 0 120 120" class="ring-progress w-16 h-16">
              <circle stroke="#eee" stroke-width="10" fill="transparent" r="52" cx="60" cy="60"></circle>
              <circle id="progress-ring" stroke="#8b5cf6" stroke-width="10" fill="transparent" r="52" cx="60" cy="60" stroke-dasharray="326.73" stroke-dashoffset="326.73"></circle>
            </svg>
            <span id="progress-text" class="absolute inset-0 grid place-items-center text-xs font-bold text-purple-700">0%</span>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mt-4">
          <div class="text-center bg-green-50 rounded-lg py-2">
            <div id="count-done" class="text-2xl font-extrabold text-green-600">0</div>
            <div class="text-xs text-green-700">×‘×•×¦×¢×• ×”×™×•×</div>
          </div>
          <div class="text-center bg-blue-50 rounded-lg py-2">
            <div id="count-active" class="text-2xl font-extrabold text-blue-600">0</div>
            <div class="text-xs text-blue-700">×¤×ª×•×—×•×ª ×¢×›×©×™×•</div>
          </div>
          <div class="text-center bg-purple-50 rounded-lg py-2">
            <div id="count-month" class="text-2xl font-extrabold text-purple-600">0</div>
            <div class="text-xs text-purple-700">×‘×•×¦×¢×• ×”×—×•×“×©</div>
          </div>
        </div>
      </div>

      <!-- Daily focus area -->
      <div class="card glass p-4 sm:p-6">
        <div class="flex items-center justify-between mb-3">
          <h3 class="text-lg font-bold text-gray-800">ğŸ¯ ×¤×•×§×•×¡ ×™×•××™ ×œ×¤×™ ××–×•×¨</h3>
          <span id="focus-area-chip" class="chip px-3 py-1 rounded-full text-xs font-semibold"></span>
        </div>
        <ul id="focus-list" class="space-y-2"></ul>
        <div class="flex gap-2 mt-4">
          <button id="btn-add-focus" class="btn px-3 py-2 rounded-lg bg-purple-600 text-white">+ ×”×•×¡×™×¤×™ ×¡×¢×™×£</button>
          <button id="btn-clear-focus" class="btn px-3 py-2 rounded-lg bg-rose-100 text-rose-700">× ×§×” ×¦×³×§-×œ×™×¡×˜</button>
        </div>
        <p class="text-xs text-gray-500 mt-2">×˜×™×¤: ×”×“×‘×™×§×™ ×›××Ÿ ×¦×¢×“×™× â€“ ×›×œ ×©×•×¨×” ×ª×”×¤×•×š ×œ×¤×¨×™×˜ ×œ×‘×™×¦×•×¢.</p>
        <textarea id="focus-input" class="mt-3 w-full rounded-xl border border-purple-200 p-3 text-sm" rows="3" placeholder="×”×“×‘×™×§×™ ×›××Ÿ ×¦×¢×“×™× (×©×•×¨×” ×œ×›×œ ×¡×¢×™×£)"></textarea>
        <button id="btn-build-focus" class="btn mt-2 w-full rounded-xl bg-purple-50 text-purple-700 py-2">×¦×•×¨/×¢×“×›×Ÿ ×¦×³×§-×œ×™×¡×˜</button>
      </div>

      <!-- Steph + Kids -->
      <div class="grid gap-6">

        <!-- Steph -->
        <div class="card glass p-4 sm:p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold text-gray-800">ğŸ§â€â™€ï¸ ×¡×˜×¤× ×™ â€“ ×§×¦×¨×•×ª ×”×™×•×</h3>
            <span class="px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-semibold">10â€“15 ×“×³ ×›×œ ××©×™××”</span>
          </div>
          <ul id="list-steph" class="space-y-2"></ul>
        </div>

        <!-- Kid: Mafal -->
        <div class="card glass p-4 sm:p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold text-gray-800">ğŸ‘§ ××¤×œ (10) â€“ 2 ×§×œ×•×ª</h3>
            <span class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-semibold">×™×•××™ ××©×ª× ×”</span>
          </div>
          <ul id="list-mafal" class="space-y-2"></ul>
        </div>

        <!-- Kid: Maayan -->
        <div class="card glass p-4 sm:p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold text-gray-800">ğŸ‘§ ××¢×™×™×Ÿ (8) â€“ 2 ×§×œ×•×ª</h3>
            <span class="px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-semibold">×™×•××™ ××©×ª× ×”</span>
          </div>
          <ul id="list-maayan" class="space-y-2"></ul>
        </div>

        <!-- Weekend -->
        <div class="card glass p-4 sm:p-6" id="weekend-card" hidden>
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold text-gray-800">ğŸ§± ××•×¨×›×‘×•×ª ×œ×¡×•×¤×´×© (×¡×˜×¤× ×™)</h3>
            <span class="px-3 py-1 rounded-full bg-amber-50 text-amber-700 text-xs font-semibold">×©×™×©×™â€“×©×‘×ª</span>
          </div>
          <ul id="list-weekend" class="space-y-2"></ul>
        </div>

      </div>

      <!-- Actions -->
      <div class="flex flex-wrap gap-3">
        <button id="btn-new" class="btn px-4 py-2 rounded-xl bg-sky-600 text-white">ğŸ”„ ×˜×¢×Ÿ ××©×™××•×ª ×—×“×©×•×ª</button>
        <button id="btn-notify" class="btn px-4 py-2 rounded-xl bg-purple-600 text-white">ğŸ”” ×‘×“×™×§×ª ×ª×–×›×•×¨×ª</button>
        <button id="btn-reset" class="btn px-4 py-2 rounded-xl bg-rose-600 text-white">ğŸ—‘ï¸ ××¤×¡ ×™×•×</button>
      </div>

      <!-- History today -->
      <div class="card glass p-4 sm:p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-3">××” ×”×•×©×œ× ×”×™×•×</h3>
        <div id="done-today" class="space-y-2 text-sm text-gray-700">
          ×¢×“×™×™×Ÿ ×œ× ×”×•×©×œ××• ××©×™××•×ª.
        </div>
      </div>

    </section>

    <!-- ====== DASHBOARD VIEW ====== -->
    <section id="view-dash" class="hidden space-y-6">

      <div class="card glass p-4 sm:p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š ×¡×™×›×•× ×—×•×“×©×™</h3>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div class="text-center bg-white rounded-xl p-3 border">
            <div class="text-xs text-gray-500">×˜×¨× ×˜×•×¤×œ×•</div>
            <div id="dash-open" class="text-2xl font-extrabold text-gray-800">0</div>
          </div>
          <div class="text-center bg-white rounded-xl p-3 border">
            <div class="text-xs text-gray-500">×“×™×œ×’×ª×™</div>
            <div id="dash-skip" class="text-2xl font-extrabold text-amber-600">0</div>
          </div>
          <div class="text-center bg-white rounded-xl p-3 border">
            <div class="text-xs text-gray-500">×”×•×©×œ××•</div>
            <div id="dash-done" class="text-2xl font-extrabold text-emerald-600">0</div>
          </div>
          <div class="text-center bg-white rounded-xl p-3 border">
            <div class="text-xs text-gray-500">×“×—×™×ª×™</div>
            <div id="dash-defer" class="text-2xl font-extrabold text-sky-600">0</div>
          </div>
        </div>
      </div>

      <div class="card glass p-4 sm:p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ  ×”×ª×§×“××•×ª ×œ×¤×™ ××–×•×¨ (×—×•×“×©×™)</h3>
        <div id="areas" class="space-y-3"></div>
      </div>

    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast hidden">
    <div class="bg-gray-900/90 text-white rounded-xl px-4 py-2 shadow-lg text-sm">×‘×“×™×§×”</div>
  </div>

<script>
/* ========= ×‘×¡×™×¡ × ×ª×•× ×™× ×§×˜×Ÿ ========= */

// ××–×•×¨×™×
const AREAS = [
  "×¡×œ×•×Ÿ","××˜×‘×—","××™","××¨×¤×¡×ª ×©×™×¨×•×ª","×—×“×¨ ××©×—×§×™×",
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ××©×—×§×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª",
  "×—×“×¨ ×™×œ×“×™×","×—×“×¨ ××¨×•× ×•×ª","×—×“×¨ ×©×™× ×” ×”×•×¨×™×",
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×","×—×¦×¨ ×§×“××™×ª","×—×¦×¨ ××—×•×¨×™×ª"
];

// ×¤×•×§×•×¡ ×™×•××™ ××•×‘× ×” (××©×™××•×ª ×§×˜× ×•×ª ×œ×›×œ ××–×•×¨)
const FOCUS_LIBRARY = {
  "×¡×œ×•×Ÿ":[
    "×œ××¡×•×£ ×¦×¢×¦×•×¢×™×/×‘×’×“×™× ××”×¡×¤×”","×œ×¤× ×•×ª ×©×•×œ×—×Ÿ ×¡×œ×•×Ÿ","× ×™×§×•×™ ×•× ×™×’×•×‘ ×©×•×œ×—×Ÿ ×¡×œ×•×Ÿ",
    "×œ×”×—×–×™×¨ × ×¢×œ×™×™× ×œ××§×•×","×œ×˜××˜× ×¡×œ×•×Ÿ ××”×™×¨","× ×™×’×•×‘ ××‘×§ ××“×£/×©×œ×˜×™×",
    "× ×™×§×•×™ ×¡×¤×•×ª â€“ ×©××™×‘×” ××”×™×¨×”","×©×•××‘ ××ª×—×ª ×œ×¡×¤×” 5 ×“×³"
  ],
  "××˜×‘×—":[
    "×œ×¤× ×•×ª ××™ â€“ ×›×œ ×¤×¨×™×˜ ×œ××§×•××•","× ×™×’×•×‘ ×”××™","××™×•×Ÿ ×“×•××¨/×“×¤×™× ×¢×œ ×”××™",
    "× ×™×’×•×‘ ×™×“×™×•×ª/××ª×’×™×","××™×•×Ÿ 1 ××’×™×¨×”","× ×™×§×•×™ ×“×œ×ª×•×ª ××¨×•× ×•×ª ××˜×‘×—"
  ],
  "××™":[ "×œ×¤× ×•×ª ××™ ×œ×—×œ×•×˜×™×Ÿ","× ×™×’×•×‘ ×™×¡×•×“×™ ×œ××™","×œ×”×—×–×™×¨ ×¨×§ ××” ×©×¦×¨×™×š" ],
  "××¨×¤×¡×ª ×©×™×¨×•×ª":[ "××™×•×Ÿ 10 ×¤×¨×™×˜×™× ×œ××“/×ª×¨×•××”","×œ×§×¤×œ ×¡×œ ×›×‘×™×¡×” ××—×“","×œ×”×—×–×™×¨ ×¡×œ×™× ×œ××§×•×" ],
  "×—×“×¨ ××©×—×§×™×":[
    "××™×¡×•×£ ×¦×¢×¦×•×¢×™× ×œ×ª×™×‘×”","××™×•×Ÿ ×¦×¢×¦×•×¢×™×: ×œ×©××•×¨/×œ×ª×¨×•×","× ×™×’×•×‘ ×©×•×œ×—×Ÿ ×™×¦×™×¨×”"
  ],
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ××©×—×§×™×":[ "× ×™×’×•×‘ ×›×™×•×¨ ×•×™×“×™×•×ª","× ×™×§×•×™ ××¡×œ×” ××”×™×¨","×©×˜×™×¤×ª ×¨×¦×¤×” × ×§×•×“×ª×™×ª" ],
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª":[ "× ×™×’×•×‘ ××¨××•×ª","× ×™×§×•×™ ×›×™×•×¨","×¡×™×“×•×¨ ××•×¦×¨×™ ×¨×—×¦×”" ],
  "×—×“×¨ ×™×œ×“×™×":[ "×”×—×–×¨×ª ×‘×’×“×™× ×œ××¨×•×Ÿ","×¡×™×“×•×¨ ×©×•×œ×—×Ÿ ×›×ª×™×‘×”","××™×¡×•×£ ××”×¨×¦×¤×”" ],
  "×—×“×¨ ××¨×•× ×•×ª":[ "××™×•×Ÿ ××“×£ ××—×“","×”×—×–×¨×ª ×‘×’×“×™× ××§×•×¤×œ×™×","×‘×“×™×§×ª ×ª×¨×•××” 5 ×¤×¨×™×˜×™×" ],
  "×—×“×¨ ×©×™× ×” ×”×•×¨×™×":[ "×¤×™× ×•×™ ×©×•×œ×™×•×ª/×©×™×“×•×ª","×”×—×œ×¤×ª ××¦×¢×™× (×× ×¦×¨×™×š)","× ×™×’×•×‘ ××‘×§ ××”×™×¨" ],
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×":[ "× ×™×§×•×™ ×›×™×•×¨","× ×™×’×•×‘ ××¨××•×ª","×¡×™×“×•×¨ ××•×¦×¨×™×" ],
  "×—×¦×¨ ×§×“××™×ª":[ "××™×¡×•×£ ×œ×›×œ×•×š ×’×œ×•×™","×˜××˜×•× ××”×™×¨","×¨×™×§×•×Ÿ ×¤×— ×× ××œ×" ],
  "×—×¦×¨ ××—×•×¨×™×ª":[ "××™×¡×•×£ ××©×—×§×™ ×—×¦×¨","×˜××˜×•× ×¤×˜×™×•","×¡×™×“×•×¨ ××–×•×¨ ×™×©×™×‘×”" ],
};

// ××©×™××•×ª ××•×¨×›×‘×•×ª (×©×™×©×™â€“×©×‘×ª)
const WEEKEND_COMPLEX = [
  "× ×™×§×•×™ ×¡×¤×•×ª (×©××™×‘×” + ×›×ª××™× × ×§×•×“×ª×™×™×)",
  "× ×™×§×•×™ ×—×œ×•× ×•×ª ×•××¡×™×œ×•×ª â€“ ×¡×œ×•×Ÿ",
  "× ×™×§×•×™ ×—×œ×•× ×•×ª ×•××¡×™×œ×•×ª â€“ ××˜×‘×—",
  "× ×™×§×•×™ ×—×œ×•× ×•×ª ×•××¡×™×œ×•×ª â€“ ×™×¦×™××” ×œ×—×¦×¨",
  "× ×™×§×•×™ ×—×œ×•× ×•×ª ×•××¡×™×œ×•×ª â€“ ×—×“×¨ ××©×—×§×™×",
  "× ×™×§×•×™ ×—×œ×•× ×•×ª ×•××¡×™×œ×•×ª â€“ ×—×“×¨ ×××‘×˜×™×” ××©×—×§×™×",
  "× ×™×§×•×™ ×—×œ×•× ×•×ª ×•××¡×™×œ×•×ª â€“ ×—×“×¨ ×™×œ×“×™×",
  "× ×™×§×•×™ ×—×œ×•× ×•×ª ×•××¡×™×œ×•×ª â€“ ×—×“×¨ ×©×™× ×” ×”×•×¨×™×",
  "× ×™×§×•×™ ×—×œ×•× ×•×ª ×•××¡×™×œ×•×ª â€“ ×—×“×¨ ×××‘×˜×™×” ×”×•×¨×™×",
  "×¡×™×“×•×¨ ××¨×•×Ÿ ××—×“ (×‘×—×¨×™ ××–×•×¨)",
  "××™×•×Ÿ ×¦×¢×¦×•×¢×™× ×¢××•×§ â€“ 30 ×“×³",
  "××™×•×Ÿ × ×™×™×¨×ª/×©×§×™×•×ª ×‘××™ â€“ 30 ×“×³"
];

// ×××’×¨ ××©×™××•×ª ×§×¦×¨×•×ª
const POOL_STEPh = [
  "×¤×™× ×•×™ ×•× ×™×’×•×‘ ×”××™ (10â€“15 ×“×³)",
  "×¤×™× ×•×™ ×©×•×œ×—×Ÿ ×¡×œ×•×Ÿ + × ×™×’×•×‘ (10 ×“×³)",
  "××™×•×Ÿ 1 ××’×™×¨×” ×‘××˜×‘×— (10 ×“×³)",
  "× ×™×’×•×‘ ××ª×’×™×/×™×“×™×•×ª ×‘×›×œ ×”×‘×™×ª (10 ×“×³)",
  "××™×•×Ÿ 10 ×¤×¨×™×˜×™× ×œ×ª×¨×•××”/××©×¤×” (10 ×“×³)",
  "×§×™×¤×•×œ ×¡×œ ×‘×’×“×™× ××—×“ (10â€“15 ×“×³)",
  "× ×™×§×•×™ ××§×œ×“×ª/×©×•×œ×—×Ÿ ×¢×‘×•×“×” (10 ×“×³)",
  "× ×™×§×•×™ ××¡×š/×©×œ×˜×™× (5â€“10 ×“×³)"
];

const POOL_KID_COMMON = [
  "×œ×”×¨×™× ×“×‘×¨×™× ××”××™ ×•×œ×”×—×–×™×¨ ×œ××§×•×",
  "×œ×”×¨×™× ×“×‘×¨×™× ××”×©×•×œ×—×Ÿ ×‘×¡×œ×•×Ÿ",
  "×œ×”×¨×™× ××”×¡×¤×” ×•×œ×”×—×–×™×¨ ×œ××§×•×",
  "× ×™×§×•×™/× ×™×’×•×‘ ×©×•×œ×—×Ÿ ×¡×œ×•×Ÿ ××• ××™",
  "×œ×˜××˜× ×¡×œ×•×Ÿ 5 ×“×³",
  "××™×¡×•×£ ×¦×¢×¦×•×¢×™× ××—×“×¨ ××©×—×§×™×",
  "××¡×“×¨×•×ª × ×¢×œ×™×™× ×‘×›× ×™×¡×”",
  "×œ×”×—×–×™×¨ ×¡×¤×¨×™× ×œ××“×£",
  "×œ×”×¢×‘×™×¨ ××’×‘ × ×§×•×“×ª×™ ×× ×™×© ×œ×›×œ×•×š",
  "×”×›× ×ª ×ª×™×§ ×œ×‘×•×§×¨ ×œ××—×¨ (×‘××§×•×)"
];

/* ========= ×¢×–×¨ ========= */

const qs = s=>document.querySelector(s);
const qsa = s=>Array.from(document.querySelectorAll(s));
const today = new Date();
const dayName = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"][today.getDay()];
qs("#today-label").textContent = dayName;
const isWeekend = today.getDay()===5 || today.getDay()===6;

const KEY = {
  STATE:"house.state.v3", // ×›×•×œ×œ counters, ×”×™×¡×˜×•×¨×™×”, ×“×—×•×™×™×
  FOCUS:"house.focus.v3"  // ×¨×©×™××ª ×¦×³×§×œ×™×¡×˜ ×œ×¤×™ ××–×•×¨ ×œ×™×•× ×”× ×•×›×—×™
};

// ×˜×¢×™× ×”/×©××™×¨×”
function loadState(){
  try{
    return JSON.parse(localStorage.getItem(KEY.STATE))||{
      monthDone:0, monthSkip:0, monthDefer:0,
      history:{}, // yyyy-mm-dd -> [{title,who,area,action}]
      todays:{done:[], open:[]}, // ids ×©×œ ××©×™××•×ª ×”×™×•×
      deferred:[] // [{title,who,area,date}]
    };
  }catch(e){return {monthDone:0,monthSkip:0,monthDefer:0,history:{},todays:{done:[],open:[]},deferred:[]}}
}
function saveState(s){localStorage.setItem(KEY.STATE,JSON.stringify(s))}
let STATE = loadState();

function dateKey(d=new Date()){
  return d.toISOString().slice(0,10);
}

/* ========= ×‘× ×™×™×ª ××©×™××•×ª ×™×•××™×•×ª ========= */

function pickRandom(arr, n){
  const a=[...arr]; const out=[];
  while(a.length && out.length<n){
    const i=Math.floor(Math.random()*a.length);
    out.push(a.splice(i,1)[0]);
  }
  return out;
}

function buildDailyTasks(){
  const todayKey = dateKey();
  // ×× ×›×‘×¨ × ×‘× ×• ×”×™×•× â€“ ×œ× × ×‘× ×” ×©×•×‘ (×¨×§ ×× ×œ×•×—×¦×™× "×˜×¢×Ÿ ××©×™××•×ª ×—×“×©×•×ª" × ××¤×¡)
  if(STATE.todays.open.length && STATE.history[todayKey]) return;

  STATE.todays.open = []; STATE.todays.done = [];
  STATE.history[todayKey] = [];

  // ×¡×˜×¤× ×™: ×-×” ×©×ª×™ ××©×™××•×ª ×§×¦×¨×•×ª; ×©×™×©×™-×©×‘×ª ××™×Ÿ ×§×¦×¨×•×ª (×¨×§ ××•×¨×›×‘×•×ª), ××‘×œ ××¤×©×¨ ×’× ×©×ª×™×™× ×§×¦×¨×•×ª ×× ×ª×¨×¦×™ â€“ ×›×¨×’×¢ ×œ×.
  if(!isWeekend){
    pickRandom(POOL_STEPh,2).forEach(t=>{
      STATE.todays.open.push({id:crypto.randomUUID(), title:t, who:"steph", area:null});
    });
  }

  // ×‘× ×•×ª â€“ ×›×œ ×™×•× 2 ×œ×›×œ ××—×ª
  pickRandom(POOL_KID_COMMON,2).forEach(t=>{
    STATE.todays.open.push({id:crypto.randomUUID(), title:t, who:"mafal", area:null});
  });
  pickRandom(POOL_KID_COMMON.filter(x=>!STATE.todays.open.some(o=>o.title===x)),2).forEach(t=>{
    STATE.todays.open.push({id:crypto.randomUUID(), title:t, who:"maayan", area:null});
  });

  // ×¡×•×¤×´×© â€“ ××©×™××•×ª ××•×¨×›×‘×•×ª ×œ×¡×˜×¤× ×™ + 2 ×§×œ×•×ª ×œ×›×œ ×™×œ×“×”
  if(isWeekend){
    pickRandom(WEEKEND_COMPLEX,3).forEach(t=>{
      STATE.todays.open.push({id:crypto.randomUUID(), title:t, who:"steph-weekend", area:null});
    });
  }

  saveState(STATE);
}

/* ========= ×¤×•×§×•×¡ ×™×•××™ ×œ×¤×™ ××–×•×¨ ========= */

function todayArea(){
  // ××—×œ×§×™× ××ª ×”×—×•×“×© ×œ××–×•×¨×™× ×‘×¨×•×˜×¦×™×”
  const day = today.getDate(); // 1..31
  return AREAS[(day-1)%AREAS.length];
}

function loadFocusList(){
  try{
    const F = JSON.parse(localStorage.getItem(KEY.FOCUS))||{};
    return F[dateKey()]||null;
  }catch(e){return null}
}
function saveFocusList(list){
  const F = JSON.parse(localStorage.getItem(KEY.FOCUS)||"{}");
  F[dateKey()] = list;
  localStorage.setItem(KEY.FOCUS, JSON.stringify(F));
}

/* ========= UI ========= */

function toast(msg){
  const t = qs("#toast");
  t.querySelector("div").textContent = msg;
  t.classList.remove("hidden");
  setTimeout(()=>t.classList.add("hidden"), 2000);
}

function renderProgress(){
  const done = STATE.todays.done.length;
  const total = STATE.todays.open.length + done;
  const pct = total? Math.round(done/total*100) : 0;
  qs("#count-done").textContent = done;
  qs("#count-active").textContent = STATE.todays.open.length;
  qs("#count-month").textContent = STATE.monthDone;
  qs("#progress-text").textContent = pct+"%";
  const circumference = 2*Math.PI*52;
  const offset = circumference - (pct/100)*circumference;
  qs("#progress-ring").style.strokeDashoffset = offset.toFixed(2);
}

function liTemplate(task){
  return `
  <li class="flex items-center justify-between bg-white border rounded-xl p-3">
    <div class="flex items-center gap-3">
      <span class="text-xl">${task.who==="mafal"?"ğŸ§’":task.who==="maayan"?"ğŸ§’":task.who==="steph-weekend"?"ğŸ§±":"ğŸ§â€â™€ï¸"}</span>
      <div>
        <div class="font-semibold text-gray-800 text-sm">${task.title}</div>
        ${task.area?`<div class="text-xs text-purple-700">${task.area}</div>`:""}
      </div>
    </div>
    <div class="flex gap-1">
      <button class="btn px-2 py-1 text-xs rounded-lg bg-emerald-100 text-emerald-700" data-act="done" data-id="${task.id}">×‘×•×¦×¢</button>
      <button class="btn px-2 py-1 text-xs rounded-lg bg-amber-100 text-amber-700" data-act="skip" data-id="${task.id}">×“×œ×’</button>
      <button class="btn px-2 py-1 text-xs rounded-lg bg-sky-100 text-sky-700" data-act="defer" data-id="${task.id}">×“×—×”</button>
    </div>
  </li>`;
}

function renderLists(){
  const steph = STATE.todays.open.filter(t=>t.who==="steph");
  const mafal = STATE.todays.open.filter(t=>t.who==="mafal");
  const maayan= STATE.todays.open.filter(t=>t.who==="maayan");
  const weekend= STATE.todays.open.filter(t=>t.who==="steph-weekend");

  qs("#list-steph").innerHTML  = steph.map(liTemplate).join("") || `<div class="text-sm text-gray-500">××™×Ÿ ×›×¨×’×¢. ×œ×—×¦×™ "×˜×¢×Ÿ ××©×™××•×ª" ×× ×ª×¨×¦×™ ×—×“×©×•×ª.</div>`;
  qs("#list-mafal").innerHTML  = mafal.map(liTemplate).join("") || `<div class="text-sm text-gray-500">××™×Ÿ ××©×™××•×ª ×›×¨×’×¢.</div>`;
  qs("#list-maayan").innerHTML = maayan.map(liTemplate).join("") || `<div class="text-sm text-gray-500">××™×Ÿ ××©×™××•×ª ×›×¨×’×¢.</div>`;

  const weekendCard = qs("#weekend-card");
  if(isWeekend){
    weekendCard.hidden = false;
    qs("#list-weekend").innerHTML = weekend.map(liTemplate).join("");
  } else {
    weekendCard.hidden = true;
  }

  // ×”×™×¡×˜×•×¨×™×” ×™×•××™×ª
  const todayKey = dateKey();
  const H = STATE.history[todayKey]||[];
  qs("#done-today").innerHTML = H.filter(x=>x.action==="done").length
    ? H.filter(x=>x.action==="done").map(x=>`<div class="bg-green-50 border border-green-100 rounded-lg p-2">âœ… ${x.title}</div>`).join("")
    : "×¢×“×™×™×Ÿ ×œ× ×”×•×©×œ××• ××©×™××•×ª.";
}

function bindListClicks(){
  ["list-steph","list-mafal","list-maayan","list-weekend"].forEach(id=>{
    const ul = qs("#"+id);
    ul.addEventListener("click", ev=>{
      const btn = ev.target.closest("button[data-id]");
      if(!btn) return;
      const id = btn.dataset.id, act = btn.dataset.act;
      const idx = STATE.todays.open.findIndex(t=>t.id===id);
      if(idx<0) return;

      const task = STATE.todays.open[idx];
      STATE.todays.open.splice(idx,1);

      const todayKey = dateKey();
      STATE.history[todayKey] = STATE.history[todayKey]||[];

      if(act==="done"){
        STATE.todays.done.push(task);
        STATE.monthDone++;
        STATE.history[todayKey].push({title:task.title, who:task.who, area:task.area, action:"done", ts:Date.now()});
      }else if(act==="skip"){
        STATE.monthSkip++;
        STATE.history[todayKey].push({title:task.title, who:task.who, area:task.area, action:"skip", ts:Date.now()});
      }else{ // defer
        STATE.monthDefer++;
        STATE.deferred.push({title:task.title, who:task.who, area:task.area, date:todayKey});
        STATE.history[todayKey].push({title:task.title, who:task.who, area:task.area, action:"defer", ts:Date.now()});
      }

      saveState(STATE);
      renderLists(); renderProgress(); renderDashboard();
    });
  });
}

/* ========= ×¤×•×§×•×¡/××–×•×¨ ========= */

function renderFocusArea(){
  const area = todayArea();
  qs("#focus-area-chip").textContent = area;

  // ×˜×¢×Ÿ/×‘×¨×™×¨×ª ××—×“×œ ××”×¡×¤×¨×™×™×”
  const saved = loadFocusList();
  let list = saved || (FOCUS_LIBRARY[area]||[]).slice(0,4);
  const ul = qs("#focus-list");
  if(!list.length){
    ul.innerHTML = `<li class="text-sm text-gray-500">×”×“×‘×™×§×™ ×œ××¢×œ×” ×¦×¢×“×™× ×•×œ×—×¦×™ "×¦×•×¨/×¢×“×›×Ÿ ×¦×³×§-×œ×™×¡×˜".</li>`;
    return;
  }
  ul.innerHTML = list.map((txt,i)=>`
    <li class="flex items-center justify-between bg-white border rounded-xl p-2">
      <label class="flex items-center gap-2">
        <input type="checkbox" class="focus-check accent-purple-600" data-idx="${i}">
        <span class="text-sm">${txt}</span>
      </label>
      <button class="btn text-xs px-2 py-1 rounded-lg bg-rose-100 text-rose-700" data-remove="${i}">×”×¡×¨</button>
    </li>
  `).join("");

  ul.onclick = (e)=>{
    const r = e.target.closest("button[data-remove]");
    if(r){
      list.splice(+r.dataset.remove,1);
      saveFocusList(list);
      renderFocusArea();
      renderDashboard();
      return;
    }
    const cb = e.target.closest("input.focus-check");
    if(cb){
      // ×¡×™××•×Ÿ ×‘×¤×¨×•×’×¨×¡ ××–×•×¨×™ â€“ × ×—×©×‘ 1 × ×§×•×“×”
      const checked = qsa("input.focus-check:checked").length;
      // ×œ× × ×“×¨×© ×©××™×¨×” ×¤×¨×˜× ×™×ª ×›×¨×’×¢; ××¡×¤×™×§ ×œ×“×•×—×•×ª ×—×•×“×©×™×™× ×“×¨×š ×”×”×™×¡×˜×•×¨×™×” ×× × ×¨×¦×”.
    }
  };
}

qs("#btn-add-focus").onclick = ()=>{
  const val = prompt("×”×•×¡×™×¤×™ ×¡×¢×™×£ ×—×“×©:");
  if(!val) return;
  const current = loadFocusList() || [];
  current.push(val);
  saveFocusList(current);
  renderFocusArea();
  renderDashboard();
};

qs("#btn-build-focus").onclick = ()=>{
  const txt = qs("#focus-input").value.trim();
  if(!txt){ toast("××™×Ÿ ×˜×§×¡×˜ ×œ×¦×³×§-×œ×™×¡×˜"); return; }
  const rows = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  saveFocusList(rows);
  qs("#focus-input").value="";
  renderFocusArea();
  toast("×”×¦×³×§-×œ×™×¡×˜ ×¢×•×“×›×Ÿ");
};

qs("#btn-clear-focus").onclick = ()=>{
  saveFocusList([]);
  renderFocusArea();
  renderDashboard();
};

/* ========= ×“×©×‘×•×¨×“ ========= */

function renderDashboard(){
  const open = STATE.todays.open.length;
  const todayKey = dateKey();
  const H = STATE.history[todayKey]||[];
  const skipped = H.filter(x=>x.action==="skip").length;
  const done = STATE.monthDone;
  const deferred = STATE.monthDefer;

  qs("#dash-open").textContent = open;
  qs("#dash-skip").textContent = skipped;
  qs("#dash-done").textContent = done;
  qs("#dash-defer").textContent = deferred;

  // ×”×ª×§×“××•×ª ××–×•×¨×™×ª â€“ ××—×©×‘×™× ×œ×¤×™ ×›××” ×¡×¢×™×¤×™× ××¡×•×× ×™×/×§×™×™××™× ×”×™×•× + ××©×™××•×ª ×¢× area ×‘×¢×ª×™×“
  const wrap = qs("#areas");
  const area = todayArea();
  const focus = loadFocusList()||[];
  const checked = qsa("input.focus-check:checked").length;

  const pct = focus.length? Math.round(checked/focus.length*100) : 0;

  wrap.innerHTML = `
    <div class="bg-white border rounded-xl p-3">
      <div class="flex items-center justify-between">
        <div class="font-semibold text-gray-800">${area}</div>
        <div class="text-sm text-purple-700">${pct}%</div>
      </div>
      <div class="w-full bg-purple-100 rounded-full h-2 mt-2">
        <div class="bg-purple-600 h-2 rounded-full" style="width:${pct}%"></div>
      </div>
      <div class="text-xs text-gray-500 mt-1">${checked}/${focus.length} ×¡×¢×™×¤×™× ××¡×•×× ×™× ×”×™×•×</div>
    </div>
  `;
}

/* ========= ×”×ª×¨××•×ª ========= */

qs("#btn-notify").onclick = async ()=>{
  try{
    if("Notification" in window){
      let perm = Notification.permission;
      if(perm==="default") perm = await Notification.requestPermission();
      if(perm==="granted"){ new Notification("ğŸ”” ×‘×“×™×§×”", { body:"×”×ª×–×›×•×¨×ª ×¢×•×‘×“×ª ğŸ˜Š" }); }
    }
    toast("×”×•×“×¢×ª ×‘×“×™×§×” × ×©×œ×—×”");
  }catch(e){ toast("×”×“×¤×“×¤×Ÿ ×—×¡× ×”×ª×¨××•×ª"); }
};

/* ========= × ×™×•×•×˜ / ×¤×¢×•×œ×•×ª ×›×œ×œ×™×•×ª ========= */

qs("#btn-new").onclick = ()=>{
  STATE.todays.open = [];
  STATE.todays.done = [];
  buildDailyTasks();
  saveState(STATE);
  renderLists(); renderProgress();
  toast("× ×˜×¢× ×• ××©×™××•×ª ×—×“×©×•×ª");
};

qs("#btn-reset").onclick = ()=>{
  if(!confirm("×œ××¤×¡ ××ª × ×ª×•× ×™ ×”×™×•×?")) return;
  const k = dateKey();
  STATE.history[k]=[];
  STATE.todays={done:[],open:[]};
  buildDailyTasks();
  saveState(STATE);
  renderLists(); renderProgress(); renderDashboard();
};

// Tabs
const homeBtn = qs("#tab-home"), dashBtn = qs("#tab-dash");
homeBtn.onclick = ()=>{
  qs("#view-home").classList.remove("hidden");
  qs("#view-dash").classList.add("hidden");
  homeBtn.classList.add("bg-purple-600","text-white");
  dashBtn.classList.remove("bg-purple-600","text-white");
  dashBtn.classList.add("hover:bg-purple-100","text-purple-700");
};
dashBtn.onclick = ()=>{
  qs("#view-home").classList.add("hidden");
  qs("#view-dash").classList.remove("hidden");
  dashBtn.classList.add("bg-purple-600","text-white");
  homeBtn.classList.remove("bg-purple-600","text-white");
  homeBtn.classList.add("hover:bg-purple-100","text-purple-700");
};

/* ========= INIT ========= */
(function init(){
  buildDailyTasks();
  renderLists(); renderProgress();
  renderFocusArea(); renderDashboard();
  bindListClicks();
})();
</script>
</body>
</html>
