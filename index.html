<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>××¨×’×•×Ÿ ×•×¡×“×¨ â€“ ×¡×˜×¤× ×™</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
  :root{--pri:#7c3aed;--pri2:#a78bfa}
  body{font-family:'Heebo',sans-serif;background:linear-gradient(180deg,#fff7ff,#f6f4ff)}
  .card{background:#fff;border-radius:18px;box-shadow:0 10px 28px rgba(0,0,0,.08)}
  .badge{background:#f1e8ff;color:#5b21b6;border-radius:999px;padding:.15rem .6rem;font-size:.8rem}
  .btn{border-radius:12px;padding:.55rem .9rem}
  .btn-ghost{background:#f6f6fb}
  .link{color:#6d28d9;text-decoration:underline}
  .nav-act{color:#fff;background:var(--pri)}
  .toast{position:fixed;inset-inline:16px;top:16px;background:var(--pri);color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.2);z-index:9999;text-align:center}
  .progress-wrap{height:8px;background:#f3f4f6;border-radius:999px}
  .progress-bar{height:8px;background:var(--pri);border-radius:999px}
  dialog::backdrop{background:rgba(0,0,0,.4)}
</style>
</head>
<body class="min-h-screen">

  <!-- NAV -->
  <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-gray-100">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-2 justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ğŸ </span>
        <b class="text-lg">××¨×’×•×Ÿ ×•×¡×“×¨</b>
      </div>
      <div class="flex gap-2">
        <a href="#/home" id="nav-home" class="btn btn-ghost">×‘×™×ª</a>
        <a href="#/dashboard" id="nav-dash" class="btn btn-ghost">×“×©×‘×•×¨×“</a>
      </div>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">

    <!-- ====== HOME ====== -->
    <section id="view-home" class="space-y-6">

      <!-- ×”×ª×¨××•×ª -->
      <div class="card p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-lg font-semibold text-gray-800">ğŸ”” ×ª×–×›×•×¨×ª ×™×•××™×ª</h2>
            <p class="text-sm text-gray-500">×”×ª×¨××” ×‘×™×Ÿ 21:00â€“22:00. × ×©××¨ ×‘××›×©×™×¨.</p>
          </div>
          <div class="flex gap-2">
            <button id="btn-notify-toggle" class="btn btn-ghost">×”×¤×¢×œ ×ª×–×›×•×¨×ª</button>
            <button id="btn-notify-test" class="btn text-white" style="background:var(--pri)">×‘×“×™×§×ª ×ª×–×›×•×¨×ª</button>
          </div>
        </div>
        <p id="notify-status" class="text-sm text-gray-500 mt-2"></p>
      </div>

      <!-- ××©×™××•×ª ×™×•××™×•×ª -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-extrabold text-gray-800">ğŸ¯ ×¤×•×§×•×¡ ×™×•××™ â€“ 3 ××©×™××•×ª ×§×¦×¨×•×ª</h2>
          <span id="today-badge" class="badge"></span>
        </div>
        <div id="daily-list" class="mt-4 grid gap-3"></div>
        <p class="text-sm text-gray-500 mt-3">×˜×™×¤: 5â€“10 ×“×³ ×œ×›×œ ××©×™××”. ×™×© â€œ×“×œ×’â€ ×•â€œ×“×—×” ×œ××—×¨â€.</p>
      </div>

      <!-- ××•×¨×›×‘×•×ª ×œ×¡×•×¤"×© -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-extrabold text-gray-800">ğŸ§± ××•×¨×›×‘×•×ª ×œ×¡×•×¤×´×©</h2>
          <span class="badge">30â€“60 ×“×³</span>
        </div>
        <div id="weekly-card" class="mt-4"></div>
      </div>

      <!-- ×ª×›× ×™×ª ×××•×§×“×ª ×œ××–×•×¨ -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-extrabold text-gray-800">ğŸ“Œ ×ª×›× ×™×ª ×××•×§×“×ª ×œ××–×•×¨</h2>
          <button id="btn-show-all" class="btn btn-ghost text-sm">×”×¦×’ ×”×›×•×œ ğŸ‘€</button>
        </div>

        <div class="grid md:grid-cols-3 gap-3 mt-3">
          <div class="md:col-span-2">
            <p class="text-sm text-gray-500">×”×“×‘×™×§×™ ×›××Ÿ ×¦×¢×“×™× â€“ ×›×œ ×©×•×¨×” ×¡×¢×™×£:</p>
            <textarea id="steps-input" rows="5" class="w-full mt-2 rounded-xl border border-gray-200 p-3 focus:outline-none focus:ring-2 focus:ring-purple-400" placeholder="1. ×œ××¡×•×£ × ×¢×œ×™×™×&#10;2. ×œ×¨×•×§×Ÿ ××ª ×”×©×•×œ×—×Ÿ&#10;3. ×œ××™×™×Ÿ ×›×‘×™×¡×”"></textarea>
          </div>
          <div>
            <label class="text-sm text-gray-600">×©×™×•×š ×œ××–×•×¨:</label>
            <select id="area-select" class="w-full mt-2 rounded-xl border border-gray-200 p-3">
              <option>×¡×œ×•×Ÿ</option>
              <option>××˜×‘×—</option>
              <option>××™</option>
              <option>××¨×¤×¡×ª ×©×™×¨×•×ª</option>
              <option>×—×“×¨ ××©×—×§×™×</option>
              <option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×</option>
              <option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª</option>
              <option>×—×“×¨ ×©×™× ×” ×™×œ×“×™×</option>
              <option>×—×“×¨ ××¨×•× ×•×ª</option>
              <option>×—×“×¨ ×©×™× ×” ×”×•×¨×™×</option>
              <option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×</option>
              <option>×—×¦×¨ ×§×“××™×ª</option>
              <option>×—×¦×¨ ××—×•×¨×™×ª</option>
            </select>
            <div class="flex flex-wrap gap-2 mt-3">
              <button id="btn-build-checklist" class="btn text-white" style="background:var(--pri)">×¦×•×¨/×¢×“×›×Ÿ ×¦×³×§Ö¾×œ×™×¡×˜ âœ…</button>
              <button id="btn-hide-done" class="btn btn-ghost">×”×¡×ª×¨ ×©×”×•×©×œ× ğŸ§¹</button>
              <button id="btn-clear" class="btn btn-ghost">× ×§×” ×¦×³×§Ö¾×œ×™×¡×˜ ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>

        <div id="checklist" class="mt-4 space-y-2"></div>
        <p class="text-sm text-gray-500 mt-2">×›×œ ×¡×¢×™×£ ××¡×•××Ÿ â†’ × ×¡×¤×¨ ×œ×”×ª×§×“××•×ª ×”××–×•×¨ ×•×œ×“×©×‘×•×¨×“.</p>
      </div>
    </section>

    <!-- ====== DASHBOARD ====== -->
    <section id="view-dashboard" class="space-y-6 hidden">

      <div class="grid md:grid-cols-3 gap-4">
        <!-- ×‘× ×™×™×Ÿ 1 -->
        <div class="card p-5">
          <h3 class="text-lg font-bold">ğŸ—ï¸ ×‘× ×™×™×Ÿ 1 â€“ ××¦×‘ ××©×™××•×ª</h3>
          <div class="mt-3 space-y-2">
            <button data-open="pending" class="w-full btn btn-ghost flex justify-between"><span>××©×™××•×ª ×©×˜×¨× ×˜×•×¤×œ×•</span><b id="stat-pending">0</b></button>
            <button data-open="skipped" class="w-full btn btn-ghost flex justify-between"><span>××©×™××•×ª ×©×“×™×œ×’×ª×™</span><b id="stat-skipped">0</b></button>
            <button data-open="done" class="w-full btn btn-ghost flex justify-between"><span>××©×™××•×ª ×©×”×•×©×œ××• (×”×—×•×“×©)</span><b id="stat-done">0</b></button>
          </div>
        </div>

        <!-- ×‘× ×™×™×Ÿ 2 -->
        <div class="card p-5">
          <h3 class="text-lg font-bold">ğŸ‘­ ×‘× ×™×™×Ÿ 2 â€“ ××©×™××•×ª ×©×œ ×”×‘× ×•×ª</h3>
          <div class="mt-3 space-y-2">
            <button data-open="owner:××¤×œ" class="w-full btn btn-ghost flex justify-between"><span>××¤×œ (10)</span><b id="stat-mafal">0</b></button>
            <button data-open="owner:××¢×™×™×Ÿ" class="w-full btn btn-ghost flex justify-between"><span>××¢×™×™×Ÿ (8)</span><b id="stat-maayan">0</b></button>
            <button data-open="owner:×× ×™" class="w-full btn btn-ghost flex justify-between"><span>×× ×™</span><b id="stat-me">0</b></button>
          </div>
        </div>

        <!-- ×‘× ×™×™×Ÿ 3 -->
        <div class="card p-5">
          <h3 class="text-lg font-bold">ğŸ“ ×‘× ×™×™×Ÿ 3 â€“ ×”×ª×§×“××•×ª ×œ×¤×™ ××–×•×¨</h3>
          <div id="areas-progress" class="mt-3 space-y-3"></div>
        </div>
      </div>

      <p class="text-sm text-gray-500">×œ×—×™×¦×” ×¢×œ ××¡×¤×¨ ×¤×•×ª×—×ª ××ª ×”×¨×©×™××”. ×œ×—×™×¦×” ×¢×œ ××–×•×¨ ×¤×•×ª×—×ª ××ª ×¡×¢×™×¤×™ ×”××–×•×¨ ×œ×¡×™××•×Ÿ.</p>
    </section>

  </main>

  <!-- MODAL: ×¨×©×™××” -->
  <dialog id="list-modal" class="rounded-2xl p-0 w-[min(92vw,600px)]">
    <div class="p-4 border-b flex items-center justify-between">
      <b id="modal-title">×¨×©×™××”</b>
      <button onclick="document.getElementById('list-modal').close()" class="btn btn-ghost">×¡×’×•×¨</button>
    </div>
    <div id="modal-body" class="p-4 max-h-[70vh] overflow-auto space-y-2"></div>
  </dialog>

<script>
/* ============== × ×ª×•× ×™× ×‘×¡×™×¡ =================*/
const OWNERS = ["×× ×™","××¤×œ","××¢×™×™×Ÿ"];
const AREAS = ["×¡×œ×•×Ÿ","××˜×‘×—","××™","××¨×¤×¡×ª ×©×™×¨×•×ª","×—×“×¨ ××©×—×§×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª","×—×“×¨ ×©×™× ×” ×™×œ×“×™×","×—×“×¨ ××¨×•× ×•×ª","×—×“×¨ ×©×™× ×” ×”×•×¨×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×","×—×¦×¨ ×§×“××™×ª","×—×¦×¨ ××—×•×¨×™×ª"];

const dailyPool = [
  { id:'sofa', icon:'ğŸ›‹ï¸', title:'×¡×¤×” â€“ ××™×¡×•×£ ×•××™×•×Ÿ', owner:'×× ×™', area:'×¡×œ×•×Ÿ', minutes:10, video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A1%D7%9C%D7%95%D7%9F+%D7%A1%D7%A4%D7%94' },
  { id:'coffee', icon:'â˜•', title:'×©×•×œ×—×Ÿ ×¡×œ×•×Ÿ â€“ ×¤×™× ×•×™ ××œ×', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:10, video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A9%D7%95%D7%9C%D7%97%D7%9F+%D7%A1%D7%9C%D7%95%D7%9F' },
  { id:'shoes', icon:'ğŸ‘Ÿ', title:'× ×¢×œ×™×™× ×‘×›× ×™×¡×”', owner:'××¢×™×™×Ÿ', area:'×¡×œ×•×Ÿ', minutes:5, video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%A0%D7%A2%D7%9C%D7%99%D7%99%D7%9D' },
  { id:'trash', icon:'ğŸ—‘ï¸', title:'××™× ×™-××©×¤×” ××”×™×¨×”', owner:'×× ×™', area:'×¡×œ×•×Ÿ', minutes:5, video:'https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%A7%D7%99%D7%95%D7%9F+%D7%9E%D7%94%D7%99%D7%A8' },
  { id:'surfaces', icon:'ğŸ§½', title:'××©×˜×—×™ ××˜×‘×— â€“ × ×™×’×•×‘', owner:'××¤×œ', area:'××˜×‘×—', minutes:10, video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%9E%D7%98%D7%91%D7%97' },
  { id:'desk', icon:'ğŸ’»', title:'×©×•×œ×—×Ÿ ×¢×‘×•×“×” â€“ 10 ×¤×¨×™×˜×™×', owner:'××¢×™×™×Ÿ', area:'×—×“×¨ ×©×™× ×” ×™×œ×“×™×', minutes:10, video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A9%D7%95%D7%9C%D7%97%D7%9F+%D7%A2%D7%91%D7%95%D7%93%D7%94' },
  { id:'bath-sink', icon:'ğŸš¿', title:'×›×™×•×¨ ×××‘×˜×™×”', owner:'×× ×™', area:'×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×', minutes:5, video:'https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%A7%D7%95%D7%99+%D7%9B%D7%99%D7%95%D7%A8' },
  { id:'laundry', icon:'ğŸ§º', title:'×›×‘×™×¡×” â€“ ×¡×‘×‘ ××—×“', owner:'××¤×œ', area:'××¨×¤×¡×ª ×©×™×¨×•×ª', minutes:5, video:'https://www.youtube.com/results?search_query=%D7%9E%D7%99%D7%95%D7%9F+%D7%9B%D7%91%D7%99%D7%A1%D7%94' },
];

const weekendPool = [
  { id:'wardrobe', icon:'ğŸ‘—', title:'××¨×•×Ÿ ×‘×’×“×™× â€“ ××“×£ ××—×“', area:'×—×“×¨ ××¨×•× ×•×ª', video:'https://www.youtube.com/results?search_query=%D7%A1%D7%99%D7%93%D7%95%D7%A8+%D7%90%D7%A8%D7%95%D7%9F+%D7%91%D7%92%D7%93%D7%99%D7%9D' },
  { id:'kitchencab', icon:'ğŸ—„ï¸', title:'××¨×•×Ÿ ××˜×‘×— â€“ ×ª×‘×œ×™× ×™×', area:'××˜×‘×—', video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%90%D7%A8%D7%95%D7%9F+%D7%9E%D7%98%D7%91%D7%97' },
  { id:'utility', icon:'ğŸ§°', title:'×—×“×¨ ×©×™×¨×•×ª â€“ ×¡×œ ××—×“', area:'××¨×¤×¡×ª ×©×™×¨×•×ª', video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%97%D7%93%D7%A8+%D7%A9%D7%99%D7%A8%D7%95%D7%AA' },
  { id:'kids-shelf', icon:'ğŸ§¸', title:'××“×£ ×¦×¢×¦×•×¢×™× â€“ ×¡×™×“×•×¨', area:'×—×“×¨ ××©×—×§×™×', video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%97%D7%93%D7%A8+%D7%9E%D7%A9%D7%97%D7%A7%D7%99%D7%9D' },
];

const STORE = {
  daily:   "v3_daily_state",    // {date: 'YYYY-MM-DD', items: {id: {status:'pending|done|skipped', owner, area, ts}}}
  weekly:  "v2_weekly_state",   // {weekKey: 'YYYY-WW', id: status}
  areaCL:  "v2_area_checklist", // [{id,text,done,area,ts}]
};

function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
function monthKey(ts){ const d=ts?new Date(ts):new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); }

/* ============== ×¢×–×¨×™ seed ×™×¦×™×‘ ×œ×™×•× ============== */
function seedPick(arr,count){
  const d = new Date(); const seed = d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate();
  const out=[]; let s=seed; const used=new Set();
  while(out.length<count && used.size<arr.length){
    s=(s*1664525+1013904223)%4294967296;
    const idx=s%arr.length; if(!used.has(idx)){used.add(idx); out.push(arr[idx]);}
  }
  return out;
}

/* ============== ××©×™××•×ª ×™×•××™×•×ª ============== */
function loadDailyState(){
  const raw = JSON.parse(localStorage.getItem(STORE.daily) || "{}");
  if(raw.date!==todayKey()) return {date:todayKey(), items:{}};
  return raw;
}
function saveDailyState(st){ localStorage.setItem(STORE.daily, JSON.stringify(st)); }

function renderDaily(){
  document.getElementById('today-badge').textContent =
    new Date().toLocaleDateString('he-IL',{weekday:'long', day:'2-digit', month:'2-digit'});

  const state = loadDailyState();
  const picked = seedPick(dailyPool,3);
  // initialize today's items if missing
  picked.forEach(t=>{
    if(!state.items[t.id]) state.items[t.id] = {status:'pending', owner:t.owner, area:t.area, ts:Date.now()};
  });
  saveDailyState(state);

  const container = document.getElementById('daily-list');
  container.innerHTML = picked.map(t=>{
    const s = state.items[t.id].status;
    const base = `
      <div class="p-4 rounded-xl border border-gray-100 flex items-start justify-between gap-3">
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="text-2xl">${t.icon}</span>
            <h3 class="font-semibold text-gray-800">${t.title}</h3>
            <span class="badge">${t.minutes} ×“×³</span>
            <span class="badge">${t.owner}</span>
            <span class="badge">${t.area}</span>
          </div>
          <a class="link text-sm" target="_blank" href="${t.video}">ğŸ¥ ×¡×¨×˜×•×Ÿ ×˜×™×¤×™×</a>
        </div>
        <div class="flex flex-col gap-2">
          <button data-act="done" data-id="${t.id}" class="btn ${s==='done'?'text-white':'btn-ghost'}" style="${s==='done'?'background:var(--pri)':''}">${s==='done'?'×‘×•×¦×¢ âœ…':'×‘×•×¦×¢'}</button>
          <button data-act="skip" data-id="${t.id}" class="btn btn-ghost">×“×œ×’ â­ï¸</button>
          <button data-act="tomorrow" data-id="${t.id}" class="btn btn-ghost">×“×—×” ×œ××—×¨ ğŸ“…</button>
        </div>
      </div>`;
    return base;
  }).join('');

  container.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id, act=btn.dataset.act;
      const st=loadDailyState();
      if(!st.items[id]) return;
      if(act==='done') st.items[id].status = (st.items[id].status==='done'?'pending':'done');
      if(act==='skip') st.items[id].status = 'skipped';
      if(act==='tomorrow'){ // ××¡××Ÿ skipped ×•×’× ×™×’×¨×•× ×œ×”×•×¤×™×¢ ××—×¨ ×›×™ ×”×‘×—×™×¨×” ×™×•××™×ª ××§×¨××™×ª-×™×¦×™×‘×”
        st.items[id].status = 'skipped';
      }
      st.items[id].ts = Date.now();
      saveDailyState(st);
      renderDaily(); renderDashboard(); // ×œ×¨×¢× ×Ÿ ×¡×˜×˜×™×¡×˜×™×§×”
      toast('×¢×•×“×›×Ÿ âœ…');
    });
  });
}

/* ============== ××•×¨×›×‘×•×ª ×œ×¡×•×¤"×© ============== */
function weekKey(){ const d=new Date(); const onejan=new Date(d.getFullYear(),0,1); const w=Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7); return d.getFullYear()+"-W"+String(w).padStart(2,'0'); }
function loadWeekly(){ return JSON.parse(localStorage.getItem(STORE.weekly) || "{}"); }
function saveWeekly(m){ localStorage.setItem(STORE.weekly, JSON.stringify(m)); }

function renderWeekly(){
  const day=new Date().getDay(); const wrap=document.getElementById('weekly-card');
  if(day!==5 && day!==6){ wrap.innerHTML='<p class="text-sm text-gray-500">×‘×¡×•×¤×´×© ×ª×•×¤×™×¢ ×›××Ÿ ××©×™××” ××—×ª ×’×“×•×œ×” ğŸ™‚</p>'; return; }
  const [task]=seedPick(weekendPool,1);
  const wk=weekKey(); const st=loadWeekly();
  const done = st[wk]===task.id;
  wrap.innerHTML=`
    <div class="p-4 rounded-xl border border-gray-100 flex items-start justify-between gap-3">
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <span class="text-2xl">${task.icon}</span>
          <h3 class="font-semibold text-gray-800">${task.title}</h3>
          <span class="badge">${task.area}</span>
        </div>
        <a class="link text-sm" target="_blank" href="${task.video}">ğŸ¬ ×¡×¨×˜×•×Ÿ ×”×©×¨××”</a>
      </div>
      <div class="flex flex-col gap-2">
        <button id="btn-weekly-done" class="btn ${done?'text-white':'btn-ghost'}" style="${done?'background:var(--pri)':''}">${done?'×‘×•×¦×¢ âœ…':'×‘×•×¦×¢'}</button>
        <button id="btn-skip-week" class="btn btn-ghost">×“×œ×’ ×œ×©×‘×•×¢ ×”×‘× â­ï¸</button>
      </div>
    </div>`;
  document.getElementById('btn-weekly-done').onclick=()=>{ const m=loadWeekly(); m[wk]=done?null:task.id; saveWeekly(m); renderWeekly(); renderDashboard(); toast('×¢×•×“×›×Ÿ âœ…'); };
  document.getElementById('btn-skip-week').onclick=()=>{ const m=loadWeekly(); m[wk]=task.id; saveWeekly(m); location.reload(); };
}

/* ============== ×¦×³×§Ö¾×œ×™×¡×˜ ×××•×§×“ (×¢× ××–×•×¨) ============== */
function loadAreaCL(){ return JSON.parse(localStorage.getItem(STORE.areaCL) || "[]"); }
function saveAreaCL(list){ localStorage.setItem(STORE.areaCL, JSON.stringify(list)); }

function buildChecklistFromText(){
  const text=document.getElementById('steps-input').value.trim();
  const area=document.getElementById('area-select').value;
  if(!text) return toast('××™×Ÿ ×¦×¢×“×™× ×œ×”×•×¡×™×£');
  const list=loadAreaCL();
  const lines=text.split('\n').map(s=>s.trim()).filter(Boolean);
  lines.forEach((t,i)=> list.push({id:'a'+Date.now()+i, text:t, done:false, area, ts:Date.now()}));
  saveAreaCL(list);
  renderChecklist(true); renderDashboard(); toast('× ×•×¦×¨ ×¦×³×§Ö¾×œ×™×¡×˜ âœ…');
}
function renderChecklist(showAll=false){
  const container=document.getElementById('checklist');
  const data=loadAreaCL(); const visible=showAll?data:data.filter(x=>!x.done);
  container.innerHTML = visible.length ? visible.map(it=>`
    <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-100">
      <input type="checkbox" ${it.done?'checked':''} data-id="${it.id}" class="h-5 w-5 rounded">
      <span class="${it.done?'line-through text-gray-400':''}">${it.text} <span class="badge">${it.area}</span></span>
    </label>
  `).join('') : `<p class="text-sm text-gray-500">××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×¦×’×”.</p>`;
  container.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change',()=>{
      const id=cb.dataset.id; const list=loadAreaCL(); const it=list.find(x=>x.id===id); if(!it) return;
      it.done=cb.checked; it.ts=Date.now(); saveAreaCL(list); renderChecklist(showAll); renderDashboard();
    });
  });
}
document.getElementById('btn-build-checklist').onclick=buildChecklistFromText;
document.getElementById('btn-hide-done').onclick=()=>renderChecklist(false);
document.getElementById('btn-show-all').onclick=()=>renderChecklist(true);
document.getElementById('btn-clear').onclick=()=>{ if(confirm('×œ× ×§×•×ª ××ª ×”×¦×³×§Ö¾×œ×™×¡×˜?')){ saveAreaCL([]); renderChecklist(true); renderDashboard(); } };

/* ============== ×“×©×‘×•×¨×“ ============== */
function renderDashboard(){
  // ×¡×˜×˜×•×¡ ××©×™××•×ª ×™×•××™×•×ª
  const st=loadDailyState();
  const pickedIds = seedPick(dailyPool,3).map(t=>t.id);
  let pending=0, skipped=0, done=0;
  let ownerMap={'×× ×™':0,'××¤×œ':0,'××¢×™×™×Ÿ':0};
  pickedIds.forEach(id=>{
    const rec=st.items[id]; if(!rec) return;
    if(rec.status==='pending') pending++;
    if(rec.status==='skipped') skipped++;
    if(rec.status==='done'){ 
      // × ×¡×¤×¨ ×‘×—×•×“×© ×”× ×•×›×—×™ ×‘×œ×‘×“
      if(monthKey(rec.ts)===monthKey()) done++;
    }
    ownerMap[rec.owner] = (ownerMap[rec.owner]||0) + (rec.status==='done'?1:0);
  });
  document.getElementById('stat-pending').textContent=pending;
  document.getElementById('stat-skipped').textContent=skipped;
  document.getElementById('stat-done').textContent=done;
  document.getElementById('stat-mafal').textContent=ownerMap['××¤×œ']||0;
  document.getElementById('stat-maayan').textContent=ownerMap['××¢×™×™×Ÿ']||0;
  document.getElementById('stat-me').textContent=ownerMap['×× ×™']||0;

  // ×”×ª×§×“××•×ª ××–×•×¨×™× (××”×¦×³×§Ö¾×œ×™×¡×˜)
  const data=loadAreaCL();
  const wrap=document.getElementById('areas-progress');
  wrap.innerHTML = AREAS.map(a=>{
    const items=data.filter(x=>x.area===a);
    const total=items.length||0; const doneC=items.filter(x=>x.done).length;
    const pct= total? Math.round(doneC*100/total) : 0;
    return `
      <button data-area="${a}" class="w-full text-left">
        <div class="flex items-center justify-between"><b>${a}</b><span class="text-sm text-gray-500">${pct}%</span></div>
        <div class="progress-wrap mt-2"><div class="progress-bar" style="width:${pct}%"></div></div>
      </button>`;
  }).join('');

  // handlers
  document.querySelectorAll('[data-open]').forEach(btn=>{
    btn.onclick = ()=> openList(btn.getAttribute('data-open'));
  });
  wrap.querySelectorAll('button[data-area]').forEach(b=>{
    b.onclick=()=> openAreaList(b.getAttribute('data-area'));
  });
}

function openList(key){
  const modal=document.getElementById('list-modal');
  const title=document.getElementById('modal-title');
  const body=document.getElementById('modal-body');
  const st=loadDailyState();
  const picked=seedPick(dailyPool,3);
  let filt=[];
  if(key==='pending') filt=picked.filter(t=>st.items[t.id]?.status==='pending');
  if(key==='skipped') filt=picked.filter(t=>st.items[t.id]?.status==='skipped');
  if(key==='done') filt=picked.filter(t=>st.items[t.id]?.status==='done' && monthKey(st.items[t.id].ts)===monthKey());
  if(key.startsWith('owner:')){ const who=key.split(':')[1]; filt=picked.filter(t=>st.items[t.id] && t.owner===who && st.items[t.id].status!=='pending'); }
  title.textContent="×¨×©×™××ª ××©×™××•×ª â€“ " + key;
  body.innerHTML = filt.length? filt.map(t=>{
    const s=st.items[t.id].status; const badge = s==='done'?'âœ… ×‘×•×¦×¢':(s==='skipped'?'â­ï¸ ×“×•×œ×’':'â³ ×××ª×™×Ÿ');
    return `<div class="p-3 rounded-xl border"><div class="flex items-center gap-2"><span class="text-xl">${t.icon}</span><b>${t.title}</b><span class="badge">${t.owner}</span><span class="badge">${t.area}</span></div><div class="text-sm text-gray-500 mt-1">${badge}</div></div>`;
  }).join('') : '<p class="text-sm text-gray-500">××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×¦×’×”.</p>';
  modal.showModal();
}

function openAreaList(area){
  const modal=document.getElementById('list-modal');
  const title=document.getElementById('modal-title');
  const body=document.getElementById('modal-body');
  title.textContent="××–×•×¨: "+area;
  const data=loadAreaCL().filter(x=>x.area===area);
  body.innerHTML = data.length? data.map(it=>{
    return `<label class="flex items-center gap-3 p-3 rounded-xl border">
      <input type="checkbox" ${it.done?'checked':''} data-id="${it.id}">
      <span class="${it.done?'line-through text-gray-400':''}">${it.text}</span>
    </label>`;
  }).join(''): '<p class="text-sm text-gray-500">××™×Ÿ ××©×™××•×ª ×œ××–×•×¨ ×–×”.</p>';
  body.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change',()=>{
      const id=cb.dataset.id; const list=loadAreaCL(); const it=list.find(x=>x.id===id); if(!it) return;
      it.done=cb.checked; it.ts=Date.now(); saveAreaCL(list); renderDashboard(); renderChecklist(true);
    });
  });
  modal.showModal();
}

/* ============== ×”×ª×¨××•×ª â€“ ××ª×•×§×Ÿ + ×‘×“×™×§×” ============== */
const NOTIFY_KEY="daily_notify_v2";
function updateNotifyUI(){
  const on = JSON.parse(localStorage.getItem(NOTIFY_KEY)||"false");
  document.getElementById('notify-status').textContent = on? "×”×ª×–×›×•×¨×ª ×¤×¢×™×œ×”":"×”×ª×–×›×•×¨×ª ×›×‘×•×™×”";
  document.getElementById('btn-notify-toggle').textContent = on? "×›×‘×” ×ª×–×›×•×¨×ª":"×”×¤×¢×œ ×ª×–×›×•×¨×ª";
}
async function enableNotifications(){
  if(!("Notification" in window)){ toast("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª"); return; }
  let p=Notification.permission; if(p==="default") p=await Notification.requestPermission();
  if(p!=="granted"){ toast("×¦×¨×™×š ×œ××©×¨ ×§×‘×œ×ª ×”×ª×¨××•×ª ×‘×“×¤×“×¤×Ÿ"); return; }
  localStorage.setItem(NOTIFY_KEY,"true"); scheduleDailyNotification(); updateNotifyUI(); toast("×ª×–×›×•×¨×ª ×”×•×¤×¢×œ×”");
}
function disableNotifications(){ localStorage.setItem(NOTIFY_KEY,"false"); clearExistingTimers(); updateNotifyUI(); toast("×ª×–×›×•×¨×ª ×›×•×‘×ª×”"); }
let notifyTimer=null;
function clearExistingTimers(){ if(notifyTimer) clearTimeout(notifyTimer); notifyTimer=null; }
function scheduleDailyNotification(){
  clearExistingTimers();
  const on = JSON.parse(localStorage.getItem(NOTIFY_KEY)||"false"); if(!on) return;
  const now=new Date(); const start=new Date(now.getFullYear(),now.getMonth(),now.getDate(),21,0,0); const end=new Date(now.getFullYear(),now.getMonth(),now.getDate(),22,0,0);
  let ms=start-now; if(ms<0){ ms=end-now; if(ms<0) ms=start.getTime()+86400000-now.getTime(); }
  notifyTimer=setTimeout(()=>{ fireNotification(); scheduleDailyNotification(); }, ms);
}
function fireNotification(){
  try{ if("Notification" in window && Notification.permission==="granted"){ new Notification("×–××Ÿ ×œ× ×™×§×™×•×Ÿ! ğŸ ",{body:"×”×’×™×¢ ×”×–××Ÿ ×œ××©×™××•×ª ×”×‘×™×ª ×©×œ×š"}); } }catch(e){}
  toast("×–××Ÿ ×œ× ×™×§×™×•×Ÿ! ğŸ§½");
}
document.getElementById('btn-notify-toggle').onclick=()=>{
  const on = JSON.parse(localStorage.getItem(NOTIFY_KEY)||"false");
  on? disableNotifications(): enableNotifications();
};
document.getElementById('btn-notify-test').onclick=async ()=>{
  if(!("Notification" in window)){ toast("××™×Ÿ ×ª××™×›×” ×‘×“×¤×“×¤×Ÿ â€“ ××•×¦×’×ª ×”×ª×¨××” ×¤× ×™××™×ª"); toast("×‘×“×™×§×”: ×¢×•×‘×“ âœ…"); return;}
  if(Notification.permission!=="granted"){ await Notification.requestPermission(); }
  fireNotification();
};

/* ============== × ×™×•×•×˜ ×‘×™×Ÿ ×“×¤×™× ============== */
function route(){
  const hash=location.hash||"#/home";
  document.getElementById('view-home').classList.toggle('hidden', hash!=="#/home");
  document.getElementById('view-dashboard').classList.toggle('hidden', hash!=="#/dashboard");
  document.getElementById('nav-home').classList.toggle('nav-act', hash==="#/home");
  document.getElementById('nav-dash').classList.toggle('nav-act', hash==="#/dashboard");
  if(hash==="#/dashboard") renderDashboard();
}
window.addEventListener('hashchange', route);

/* ============== Toast ×§×˜×Ÿ ============== */
function toast(msg){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),2500); }

/* ============== Init ============== */
document.addEventListener('DOMContentLoaded', ()=>{
  route();
  renderDaily(); renderWeekly(); renderChecklist(true); renderDashboard();
  updateNotifyUI(); if(JSON.parse(localStorage.getItem(NOTIFY_KEY)||"false")) scheduleDailyNotification();
});
</script>
</body>
</html>
