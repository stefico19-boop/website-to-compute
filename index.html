<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>××¨×’×•×Ÿ ×•×¡×“×¨ â€“ ×¡×˜×¤× ×™</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#b08d57">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;600;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
<style>
  :root{--gold:#b08d57;--ink:#1c1b1a;--card:#ffffff}
  body{font-family:'Heebo',sans-serif;background:linear-gradient(180deg,#fffdf8,#faf7ff)}
  h1,h2,h3{font-family:'Playfair Display',serif}
  .card{background:var(--card);border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.08);border:1px solid rgba(176,141,87,.15)}
  .badge{background:#fff3d9;color:#6b4b1d;border:1px solid rgba(176,141,87,.35);border-radius:999px;padding:.15rem .6rem;font-size:.8rem}
  .btn{border-radius:12px;padding:.55rem .9rem;border:1px solid rgba(28,27,26,.08)}
  .btn-ghost{background:#f8f6ff}
  .btn-gold{background:var(--gold);color:#fff}
  .link{color:#6d28d9;text-decoration:underline}
  .nav-act{color:#fff;background:var(--gold)}
  .toast{position:fixed;inset-inline:16px;top:16px;background:var(--gold);color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.2);z-index:9999;text-align:center}
  .progress-wrap{height:8px;background:#f3f4f6;border-radius:999px}
  .progress-bar{height:8px;background:var(--gold);border-radius:999px}
  dialog::backdrop{background:rgba(0,0,0,.4)}
</style>
</head>
<body class="min-h-screen text-[15px]" >

  <!-- NAV -->
  <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-[rgba(176,141,87,.25)]">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-2 justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ğŸ </span>
        <b class="text-lg">××¨×’×•×Ÿ ×•×¡×“×¨</b>
      </div>
      <div class="flex gap-2">
        <a href="#/home" id="nav-home" class="btn btn-ghost">×‘×™×ª</a>
        <a href="#/dashboard" id="nav-dash" class="btn btn-ghost">×“×©×‘×•×¨×“</a>
        <button id="btn-install" class="btn btn-ghost hidden">×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×” ğŸ“²</button>
      </div>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">

    <!-- ====== HOME ====== -->
    <section id="view-home" class="space-y-6">

      <!-- ×”×ª×¨××•×ª -->
      <div class="card p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-xl">ğŸ”” ×ª×–×›×•×¨×ª ×™×•××™×ª</h2>
            <p class="text-sm text-gray-500">×”×ª×¨××” ×‘×™×Ÿ 21:00â€“22:00. × ×©××¨ ×‘××›×©×™×¨.</p>
          </div>
          <div class="flex gap-2">
            <button id="btn-notify-toggle" class="btn btn-ghost">×”×¤×¢×œ ×ª×–×›×•×¨×ª</button>
            <button id="btn-notify-test" class="btn btn-gold">×‘×“×™×§×ª ×ª×–×›×•×¨×ª</button>
          </div>
        </div>
        <p id="notify-status" class="text-sm text-gray-500 mt-2"></p>
      </div>

      <!-- ××©×™××•×ª ×™×•××™×•×ª -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl">ğŸ¯ ×¤×•×§×•×¡ ×™×•××™</h2>
          <span id="today-badge" class="badge"></span>
        </div>
        <p class="text-sm text-gray-500 mt-1">
          ××³â€“×”×³: 2 ×œ××¤×œ â€¢ 2 ×œ××¢×™×™×Ÿ â€¢ 2 ×œ×¡×˜×¤× ×™ (5â€“15 ×“×³ ×œ××©×™××”) | ×•×³â€“×©×³: 1 ×œ××¤×œ â€¢ 1 ×œ××¢×™×™×Ÿ
        </p>
        <div id="daily-list" class="mt-4 grid gap-3"></div>
      </div>

      <!-- ××•×¨×›×‘×•×ª ×œ×¡×•×¤"×© â€“ ×œ×¡×˜×¤× ×™ -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl">ğŸ§± ××•×¨×›×‘×•×ª ×œ×¡×•×¤×´×© (×œ×¡×˜×¤× ×™)</h2>
          <span class="badge">30â€“60 ×“×³</span>
        </div>
        <div id="weekly-card" class="mt-4"></div>
      </div>

      <!-- ×ª×›× ×™×ª ×××•×§×“×ª ×œ××–×•×¨ (×¦×³×§Ö¾×œ×™×¡×˜ ×©×œ×š) -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl">ğŸ“Œ ×ª×›× ×™×ª ×××•×§×“×ª ×œ××–×•×¨ (×¦×³×§Ö¾×œ×™×¡×˜)</h2>
          <button id="btn-show-all" class="btn btn-ghost text-sm">×”×¦×’ ×”×›×•×œ ğŸ‘€</button>
        </div>

        <div class="grid md:grid-cols-3 gap-3 mt-3">
          <div class="md:col-span-2">
            <p class="text-sm text-gray-500">×”×“×‘×™×§×™ ×›××Ÿ ×¦×¢×“×™× â€“ ×›×œ ×©×•×¨×” ×¡×¢×™×£:</p>
            <textarea id="steps-input" rows="5" class="w-full mt-2 rounded-xl border border-gray-200 p-3 focus:outline-none focus:ring-2 focus:ring-[var(--gold)]" placeholder="1. ×œ××¡×•×£ × ×¢×œ×™×™×&#10;2. ×œ×¨×•×§×Ÿ ××ª ×”×©×•×œ×—×Ÿ&#10;3. ×œ××™×™×Ÿ ×›×‘×™×¡×”"></textarea>
          </div>
          <div>
            <label class="text-sm">×©×™×•×š ×œ××–×•×¨:</label>
            <select id="area-select" class="w-full mt-2 rounded-xl border border-gray-200 p-3">
              <option>×¡×œ×•×Ÿ</option><option>××˜×‘×—</option><option>××™</option><option>××¨×¤×¡×ª ×©×™×¨×•×ª</option><option>×—×“×¨ ××©×—×§×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª</option><option>×—×“×¨ ×©×™× ×” ×™×œ×“×™×</option><option>×—×“×¨ ××¨×•× ×•×ª</option><option>×—×“×¨ ×©×™× ×” ×”×•×¨×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×</option><option>×—×¦×¨ ×§×“××™×ª</option><option>×—×¦×¨ ××—×•×¨×™×ª</option>
            </select>
            <div class="flex flex-wrap gap-2 mt-3">
              <button id="btn-build-checklist" class="btn btn-gold">×¦×•×¨/×¢×“×›×Ÿ ×¦×³×§Ö¾×œ×™×¡×˜ âœ…</button>
              <button id="btn-hide-done" class="btn btn-ghost">×”×¡×ª×¨ ×©×”×•×©×œ× ğŸ§¹</button>
              <button id="btn-clear" class="btn btn-ghost">× ×§×” ×¦×³×§Ö¾×œ×™×¡×˜ ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>

        <div id="checklist" class="mt-4 space-y-2"></div>
        <p class="text-sm text-gray-500 mt-2">×¡×¢×™×¤×™× ××¡×•×× ×™× × ×¡×¤×¨×™× ×œ×”×ª×§×“××•×ª ×”××–×•×¨ **×”×—×•×“×©×™×ª**.</p>
      </div>

      <!-- ×ª×›× ×™×ª ×—×•×“×©×™×ª ×œ×¤×™ ××–×•×¨ (××•×‘× ×”) -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl">ğŸ“… ×ª×›× ×™×ª ×—×•×“×©×™×ª â€“ ×œ×¤×™ ××–×•×¨</h2>
          <div class="flex gap-2 items-center">
            <select id="plan-area-select" class="rounded-xl border border-gray-200 p-2">
              <option>×¡×œ×•×Ÿ</option><option>××˜×‘×—</option><option>××™</option><option>××¨×¤×¡×ª ×©×™×¨×•×ª</option><option>×—×“×¨ ××©×—×§×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª</option><option>×—×“×¨ ×©×™× ×” ×™×œ×“×™×</option><option>×—×“×¨ ××¨×•× ×•×ª</option><option>×—×“×¨ ×©×™× ×” ×”×•×¨×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×</option><option>×—×¦×¨ ×§×“××™×ª</option><option>×—×¦×¨ ××—×•×¨×™×ª</option>
            </select>
            <button id="btn-plan-open" class="btn btn-ghost">×¤×ª×— ×¨×©×™××ª ××–×•×¨ âœ¨</button>
          </div>
        </div>
        <p class="text-sm text-gray-500 mt-2">×›×•×œ×œ â€œ× ×™×§×•×™ ×¡×¤×•×ªâ€ + â€œ×—×œ×•× ×•×ª/××¡×™×œ×•×ªâ€ ×‘×›×œ ×”××–×•×¨×™× ×©×‘×™×§×©×ª.</p>
      </div>
    </section>

    <!-- ====== DASHBOARD ====== -->
    <section id="view-dashboard" class="space-y-6 hidden">
      <div class="grid md:grid-cols-3 gap-4">
        <!-- ×‘× ×™×™×Ÿ 1 -->
        <div class="card p-5">
          <h3 class="text-xl">ğŸ—ï¸ ×‘× ×™×™×Ÿ 1 â€“ ××¦×‘ ××©×™××•×ª (×”×™×•×)</h3>
          <div class="mt-3 space-y-2">
            <button data-open="pending" class="w-full btn btn-ghost flex justify-between"><span>×©×˜×¨× ×˜×•×¤×œ×•</span><b id="stat-pending">0</b></button>
            <button data-open="skipped" class="w-full btn btn-ghost flex justify-between"><span>×©×“×™×œ×’×ª×™</span><b id="stat-skipped">0</b></button>
            <button data-open="done" class="w-full btn btn-ghost flex justify-between"><span>×©×”×•×©×œ××• (×”×—×•×“×©)</span><b id="stat-done">0</b></button>
          </div>
        </div>

        <!-- ×‘× ×™×™×Ÿ 2 -->
        <div class="card p-5">
          <h3 class="text-xl">ğŸ‘­ ×‘× ×™×™×Ÿ 2 â€“ ×”×‘× ×•×ª: × ×§×•×“×•×ª ×”×©×‘×•×¢</h3>
          <div class="mt-3 space-y-2">
            <div class="flex items-center justify-between">
              <span>××¤×œ</span><b id="pts-mafal">0</b>
            </div>
            <div class="flex items-center justify-between">
              <span>××¢×™×™×Ÿ</span><b id="pts-maayan">0</b>
            </div>
            <p class="text-sm text-gray-500 mt-1">×›×œ â€œ×‘×•×¦×¢â€ ×‘××©×™××” ×©×œ ×”×‘×ª = × ×§×•×“×”. ××ª××¤×¡ ×›×œ ×©×‘×•×¢.</p>
          </div>
        </div>

        <!-- ×‘× ×™×™×Ÿ 3 -->
        <div class="card p-5">
          <h3 class="text-xl">ğŸ“ ×‘× ×™×™×Ÿ 3 â€“ ×”×ª×§×“××•×ª ×—×•×“×©×™×ª ×œ×¤×™ ××–×•×¨</h3>
          <div id="areas-progress" class="mt-3 space-y-3"></div>
          <p class="text-sm text-gray-500 mt-2">×”×ª×§×“××•×ª = ×ª×›× ×™×ª ×—×•×“×©×™×ª ×©×¡×•×× ×” + ×¤×¨×™×˜×™ ×¦×³×§Ö¾×œ×™×¡×˜ ××”×—×•×“×©.</p>
        </div>

        <!-- ×‘× ×™×™×Ÿ 4: ×”×™×¡×˜×•×¨×™×™×ª × ×§×•×“×•×ª -->
        <div class="card p-5 md:col-span-3">
          <h3 class="text-xl">ğŸ“… ×”×™×¡×˜×•×¨×™×™×ª × ×§×•×“×•×ª â€“ ×©×‘×•×¢×•×ª ×§×•×“××™×</h3>
          <div id="points-history" class="mt-3 overflow-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500">
                  <th class="text-right p-2">×©×‘×•×¢</th>
                  <th class="text-right p-2">××¤×œ</th>
                  <th class="text-right p-2">××¢×™×™×Ÿ</th>
                  <th class="text-right p-2">×¡×”×´×›</th>
                  <th class="text-right p-2">×¤×¨×¡×™×</th>
                </tr>
              </thead>
              <tbody id="points-history-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL: ×¨×©×™××” / ××–×•×¨ -->
  <dialog id="list-modal" class="rounded-2xl p-0 w-[min(92vw,640px)]">
    <div class="p-4 border-b flex items-center justify-between">
      <b id="modal-title">×¨×©×™××”</b>
      <button onclick="document.getElementById('list-modal').close()" class="btn btn-ghost">×¡×’×•×¨</button>
    </div>
    <div id="modal-body" class="p-4 max-h-[70vh] overflow-auto space-y-2"></div>
  </dialog>

<script>
/* ===================== ×‘×¡×™×¡ + STORE ===================== */
const OWNERS = ["×× ×™","××¤×œ","××¢×™×™×Ÿ"];
const AREAS  = ["×¡×œ×•×Ÿ","××˜×‘×—","××™","××¨×¤×¡×ª ×©×™×¨×•×ª","×—×“×¨ ××©×—×§×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª","×—×“×¨ ×©×™× ×” ×™×œ×“×™×","×—×“×¨ ××¨×•× ×•×ª","×—×“×¨ ×©×™× ×” ×”×•×¨×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×","×—×¦×¨ ×§×“××™×ª","×—×¦×¨ ××—×•×¨×™×ª"];

const STORE = {
  daily:   "v5_daily_state",
  weekly:  "v3_weekly_state",
  areaCL:  "v3_area_checklist",
  plan:    "v1_area_month_plan",
  notify:  "daily_notify_v2",
  points:  "v1_points_week",     // {week:'YYYY-Wxx', mafal:Number, maayan:Number}
  history: "v1_points_history",  // [{week, mafal, maayan, total, rewards:[...]}, ...]
  rewards: "v1_rewards"          // [{week, owner, milestone, ts}]
};

function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
function monthKey(ts){ const d=ts?new Date(ts):new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); }
function weekKey(){ const d=new Date(); const onejan=new Date(d.getFullYear(),0,1); const w=Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7); return d.getFullYear()+"-W"+String(w).padStart(2,'0'); }

/* ===================== ×××’×¨×™ ××©×™××•×ª ×™×•××™×•×ª ===================== */
const poolMafal = [
  { id:'maf_island_pick', icon:'ğŸŸ£', title:'×œ××¡×•×£ ×—×¤×¦×™× ××”××™', owner:'××¤×œ', area:'××™', minutes:5,  video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%90%D7%99+%D7%9E%D7%98%D7%91%D7%97' },
  { id:'maf_table_pick',  icon:'ğŸŸ£', title:'×œ××¡×•×£ ××”×©×•×œ×—×Ÿ ×‘×¡×œ×•×Ÿ', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:5,  video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A9%D7%95%D7%9C%D7%97%D7%9F+%D7%A1%D7%9C%D7%95%D7%9F' },
  { id:'maf_sofa_pick',   icon:'ğŸŸ£', title:'×œ××¡×•×£ ××”×¡×¤×” (×‘×’×“×™×/×¦×¢×¦×•×¢×™×)', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:5,  video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A1%D7%A4%D7%94' },
  { id:'maf_wipe_island', icon:'ğŸ§»', title:'× ×™×’×•×‘ ××”×™×¨ â€“ ××™', owner:'××¤×œ', area:'××™', minutes:7,  video:'https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%92%D7%95%D7%91+%D7%9E%D7%A9%D7%98%D7%97%D7%99%D7%9D' },
  { id:'maf_wipe_table',  icon:'ğŸ§»', title:'× ×™×’×•×‘ ××”×™×¨ â€“ ×©×•×œ×—×Ÿ ×¡×œ×•×Ÿ', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:7,  video:'https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%A7%D7%95%D7%99+%D7%A9%D7%95%D7%9C%D7%97%D7%9F+%D7%A1%D7%9C%D7%95%D7%9F' },
  { id:'maf_broom_living',icon:'ğŸ§¹', title:'×œ×˜××˜× ××ª ×”×¡×œ×•×Ÿ (2 ×“×³)', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:5, video:'https://www.youtube.com/results?search_query=%D7%98%D7%99%D7%90%D7%95%D7%98+%D7%9E%D7%94%D7%99%D7%A8' },
  { id:'maf_cushions',    icon:'ğŸ›‹ï¸', title:'×œ×¡×“×¨ ×›×¨×™×•×ª ×•×©××™×›×” ×‘×¡×¤×”', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:5, video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A1%D7%9C%D7%95%D7%9F' },
];

const poolMaayan = [
  { id:'may_island_pick', icon:'ğŸŸ¢', title:'×œ××¡×•×£ ×—×¤×¦×™× ××”××™', owner:'××¢×™×™×Ÿ', area:'××™', minutes:5,  video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%90%D7%99+%D7%9E%D7%98%D7%91%D7%97' },
  { id:'may_table_pick',  icon:'ğŸŸ¢', title:'×œ××¡×•×£ ××”×©×•×œ×—×Ÿ ×‘×¡×œ×•×Ÿ', owner:'××¢×™×™×Ÿ', area:'×¡×œ×•×Ÿ', minutes:5,  video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A9%D7%95%D7%9C%D7%97%D7%9F+%D7%A1%D7%9C%D7%95%D7%9F' },
  { id:'may_wipe_island', icon:'ğŸ§»', title:'× ×™×’×•×‘ ××”×™×¨ â€“ ××™', owner:'××¢×™×™×Ÿ', area:'××™', minutes:6,  video:'https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%92%D7%95%D7%91+%D7%9E%D7%A9%D7%98%D7%97%D7%99%D7%9D' },
  { id:'may_wipe_table',  icon:'ğŸ§»', title:'× ×™×’×•×‘ ××”×™×¨ â€“ ×©×•×œ×—×Ÿ ×¡×œ×•×Ÿ', owner:'××¢×™×™×Ÿ', area:'×¡×œ×•×Ÿ', minutes:6,  video:'https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%A7%D7%95%D7%99+%D7%A9%D7%95%D7%9C%D7%97%D7%9F+%D7%A1%D7%9C%D7%95%D7%9F' },
  { id:'may_broom_living',icon:'ğŸ§¹', title:'×œ×˜××˜× × ×§×•×“×ª×™ ×‘×¡×œ×•×Ÿ', owner:'××¢×™×™×Ÿ', area:'×¡×œ×•×Ÿ', minutes:5, video:'https://www.youtube.com/results?search_query=%D7%98%D7%99%D7%90%D7%95%D7%98+%D7%9E%D7%94%D7%99%D7%A8' },
  { id:'may_toys_bin',    icon:'ğŸ§¸', title:'×œ×”×—×–×™×¨ ×¦×¢×¦×•×¢×™× ×œ×¡×œ', owner:'××¢×™×™×Ÿ', area:'×—×“×¨ ××©×—×§×™×', minutes:7, video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%A6%D7%A2%D7%A6%D7%95%D7%A2%D7%99%D7%9D' },
];

const poolSteph = [
  { id:'st_fold10',      icon:'ğŸ§º', title:'×œ×§×¤×œ 10 ×¤×¨×™×˜×™× ×•×œ×”×—×–×™×¨ ×œ××¨×•×Ÿ', owner:'×× ×™', area:'×—×“×¨ ××¨×•× ×•×ª', minutes:12, video:'https://www.youtube.com/results?search_query=%D7%A7%D7%99%D7%A4%D7%95%D7%9C+%D7%9B%D7%91%D7%99%D7%A1%D7%94+%D7%9E%D7%94%D7%99%D7%A8' },
  { id:'st_paper5',      icon:'ğŸ—‚ï¸', title:'×œ××™×™×Ÿ 5 × ×™×™×¨×•×ª/×“×•××¨', owner:'×× ×™', area:'×¡×œ×•×Ÿ', minutes:10, video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%A0%D7%99%D7%99%D7%A8%D7%95%D7%AA' },
  { id:'st_bath_sink',   icon:'ğŸš¿', title:'×›×™×•×¨ ×××‘×˜×™×” ××”×™×¨', owner:'×× ×™', area:'×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×', minutes:12, video:'https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%A7%D7%95%D7%99+%D7%9B%D7%99%D7%95%D7%A8' },
  { id:'st_entry5',      icon:'ğŸšª', title:'×›× ×™×¡×” â€“ 5 ×¤×¨×™×˜×™× ×œ××§×•×', owner:'×× ×™', area:'×¡×œ×•×Ÿ', minutes:10, video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%9B%D7%A0%D7%99%D7%A1%D7%94' },
];

/* ===================== ×ª×›× ×™×ª ×—×•×“×©×™×ª ××¤×•×¨×˜×ª (×›×•×œ×œ ×¡×¤×•×ª/×—×œ×•× ×•×ª) ===================== */
const AREA_PLAN = {
  "×¡×œ×•×Ÿ": [
    {id:"lv_sofa_deep",  text:"× ×™×§×•×™ ×¡×¤×•×ª â€“ ×©××™×‘×” + ×˜×™×¤×•×œ ×›×ª××™×", video:"https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%A7%D7%95%D7%99+%D7%A1%D7%A4%D7%95%D7%AA"},
    {id:"lv_windows",    text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×¡×œ×•×Ÿ",     video:"https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%A7%D7%95%D7%99+%D7%9E%D7%A1%D7%99%D7%9C%D7%95%D7%AA+%D7%97%D7%9C%D7%95%D7%A0%D7%95%D7%AA"},
    {id:"lv_shelves",    text:"××“×¤×™ ×˜×œ×•×•×™×–×™×”/×¡×¤×¨×™× â€“ ××‘×§ ×•×¡×™×“×•×¨"},
    {id:"lv_rug",        text:"×©×˜×™×— â€“ ×©××™×‘×” ×™×¡×•×“×™×ª"},
    {id:"lv_switches",   text:"××ª×’×™×/×™×“×™×•×ª â€“ × ×™×’×•×‘ ×—×™×˜×•×™"},
  ],
  "××˜×‘×—": [
    {id:"kt_windows",    text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ××˜×‘×—",     video:"https://www.youtube.com/results?search_query=%D7%9E%D7%A1%D7%99%D7%9C%D7%95%D7%AA+%D7%97%D7%9C%D7%95%D7%A0%D7%95%D7%AA+%D7%9E%D7%98%D7%91%D7%97"},
    {id:"kt_counters",   text:"××©×˜×—×™× â€“ ×¤×™× ×•×™ ×•× ×™×’×•×‘ ×™×¡×•×“×™"},
    {id:"kt_fridge",     text:"××§×¨×¨ â€“ ××“×£/××’×© ××—×“"},
    {id:"kt_spices",     text:"××“×£ ×ª×‘×œ×™× ×™× â€“ ×”×•×¦××”, × ×™×’×•×‘, ×”×—×–×¨×” ×œ×¤×™ ×§×˜×’×•×¨×™×”"},
  ],
  "××™": [
    {id:"island_clear",  text:"××™ â€“ ×¤×™× ×•×™ ××œ×, × ×™×’×•×‘, ×”×—×–×¨×” ××¡×•×“×¨×ª"},
  ],
  "××¨×¤×¡×ª ×©×™×¨×•×ª": [
    {id:"ut_windows",    text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×™×¦×™××” ×œ×—×¦×¨"},
    {id:"ut_bins",       text:"××™×•×Ÿ 2 ×¡×œ×™ ××—×¡×•×Ÿ"},
  ],
  "×—×“×¨ ××©×—×§×™×": [
    {id:"pl_windows",    text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×—×“×¨ ××©×—×§×™×"},
    {id:"pl_shelf",      text:"××“×£ ×¦×¢×¦×•×¢×™× â€“ ×¡×™×“×•×¨ + ×§×•×¤×¡×ª ×ª×¨×•××”"},
  ],
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×": [
    {id:"bpl_windows",   text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×××‘×˜×™×” ××©×—×§×™×"},
    {id:"bpl_sink",      text:"×›×™×•×¨/×‘×¨×– â€“ × ×™×§×•×™ ××‘× ×™×ª"},
  ],
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª": [
    {id:"bg_windows",    text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×××‘×˜×™×” ×‘× ×•×ª"},
    {id:"bg_cabinet",    text:"××¨×•×Ÿ â€“ ××“×£ ××—×“"},
  ],
  "×—×“×¨ ×©×™× ×” ×™×œ×“×™×": [
    {id:"kr_windows",    text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×—×“×¨ ×™×œ×“×™×"},
    {id:"kr_shelf",      text:"×©×•×œ×—×Ÿ/××“×£ â€“ 10 ×¤×¨×™×˜×™× ×œ××§×•×"},
  ],
  "×—×“×¨ ××¨×•× ×•×ª": [
    {id:"cl_shelf",      text:"××“×£ ××—×“ â€“ ×§×™×¤×•×œ ×•××™×•×Ÿ (×ª×¨×•××”/×œ×–×¨×•×§)"},
  ],
  "×—×“×¨ ×©×™× ×” ×”×•×¨×™×": [
    {id:"pr_windows",    text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×—×“×¨ ×”×•×¨×™×"},
    {id:"pr_tables",     text:"×©×™×“×•×ª ×œ×™×œ×” â€“ ×¤×™× ×•×™ ×•× ×™×’×•×‘"},
  ],
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×": [
    {id:"bp_windows",    text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×××‘×˜×™×” ×”×•×¨×™×"},
    {id:"bp_glass",      text:"×–×›×•×›×™×ª ××§×œ×—×•×Ÿ â€“ × ×™×’×•×‘ ×›×ª××™ ××™×"},
  ],
  "×—×¦×¨ ×§×“××™×ª": [
    {id:"yd_front",      text:"×˜××˜×•× ×•× ×™×§×•×™ ×¤×™× ×ª ×™×©×™×‘×”"},
  ],
  "×—×¦×¨ ××—×•×¨×™×ª": [
    {id:"yd_back",       text:"×˜××˜×•×, ××¨×’×•×Ÿ ×¦×¢×¦×•×¢×™ ×—×¦×¨"},
  ],
};

/* ===================== ×ª×›× ×™×ª ×—×•×“×©×™×ª â€“ ×¡×˜×˜×•×¡ ===================== */
function loadPlan(){
  const raw = JSON.parse(localStorage.getItem(STORE.plan)||"{}");
  const mk = monthKey();
  if(raw.month!==mk) return {month:mk, done:{}}; 
  return raw;
}
function savePlan(p){ localStorage.setItem(STORE.plan, JSON.stringify(p)); }

/* ===================== ×™×•××™: ×‘×—×™×¨×” ×•×¨×™× ×“×•×¨ ===================== */
function seedPick(arr,count){
  const d = new Date(); const seed = d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate();
  const out=[]; let s=seed; const used=new Set();
  while(out.length<count && used.size<arr.length){
    s=(s*1664525+1013904223)%4294967296;
    const idx=s%arr.length; if(!used.has(idx)){used.add(idx); out.push(arr[idx]);}
  }
  return out;
}
function isWeekend(){ const day=new Date().getDay(); return (day===5 || day===6); } // ×©×™×©×™/×©×‘×ª
function todaysTasks(){
  const list=[];
  if(isWeekend()){
    // ×•×³â€“×©×³: 1 ××©×™××” ×œ××¤×œ + 1 ×œ××¢×™×™×Ÿ (×§×œ×•×ª)
    seedPick(poolMafal,1).forEach(t=>list.push(t));
    seedPick(poolMaayan,1).forEach(t=>list.push(t));
  }else{
    // ××³â€“×”×³: 2+2+2
    seedPick(poolMafal,2).forEach(t=>list.push(t));
    seedPick(poolMaayan,2).forEach(t=>list.push(t));
    seedPick(poolSteph,2).forEach(t=>list.push(t));
  }
  return list;
}

function loadDailyState(){
  const raw = JSON.parse(localStorage.getItem(STORE.daily) || "{}");
  if(raw.date!==todayKey()) return {date:todayKey(), items:{}};
  return raw;
}
function saveDailyState(st){ localStorage.setItem(STORE.daily, JSON.stringify(st)); }

/* ===== × ×§×•×“×•×ª ×©×‘×•×¢×™×•×ª + ×”×™×¡×˜×•×¨×™×” + ×¤×¨×¡×™× ===== */
function loadPoints(){
  const raw = JSON.parse(localStorage.getItem(STORE.points)||"{}");
  const wk = weekKey();
  if(raw.week!==wk) return {week:wk, mafal:0, maayan:0};
  return raw;
}
function savePoints(p){ localStorage.setItem(STORE.points, JSON.stringify(p)); }

function loadHistory(){ return JSON.parse(localStorage.getItem(STORE.history)||"[]"); }
function saveHistory(h){ localStorage.setItem(STORE.history, JSON.stringify(h)); }

function appendWeekToHistory(prev){
  if(!prev?.week) return;
  const hist = loadHistory();
  const total = (prev.mafal||0)+(prev.maayan||0);
  const rw = JSON.parse(localStorage.getItem(STORE.rewards)||"[]").filter(r=>r.week===prev.week);
  hist.unshift({week: prev.week, mafal: prev.mafal||0, maayan: prev.maayan||0, total, rewards: rw});
  saveHistory(hist);
}

function ensureWeekRollover(){
  const raw = JSON.parse(localStorage.getItem(STORE.points)||"{}");
  const wk = weekKey();
  if(raw.week && raw.week !== wk){
    appendWeekToHistory(raw);
    savePoints({week:wk, mafal:0, maayan:0});
  }else if(!raw.week){
    savePoints({week:wk, mafal:0, maayan:0});
  }
}

function pushReward(owner, milestone){
  const list = JSON.parse(localStorage.getItem(STORE.rewards)||"[]");
  list.push({week: weekKey(), owner, milestone, ts: Date.now()});
  localStorage.setItem(STORE.rewards, JSON.stringify(list));
}

function checkRewards(owner, prevVal, newVal){
  [10,20].forEach(m=>{
    if(prevVal < m && newVal >= m){
      pushReward(owner, m);
      toast(`ğŸ… ×›×œ ×”×›×‘×•×“ ${owner}! ×”×’×¢×ª ×œÖ¾${m} × ×§×³ ×”×©×‘×•×¢ ğŸ‰`);
    }
  });
}

/* ×”×•×“×¢×•×ª ××•×˜×™×‘×¦×™×” */
const MOTIVATION = {
  "×× ×™":    ["×›×œ ×¦×¢×“ ×§×˜×Ÿ â€“ ×‘×™×ª ×’×“×•×œ âœ¨","×¡×™×™××ª! ×¢×•×“ 10 ×“×§×•×ª ×•××ª ××œ×›×” ğŸ‘‘","×™×¤×”! ××ª ×¢×œ ×–×” ğŸ”¥"],
  "××¤×œ":   ["××¤×œ ××œ×•×¤×”! ğŸ’œ","××™×–×• ×—×¨×•×¦×”! ×”××©×›×ª ××¢×•×œ×” ğŸ‘","WOW ××¤×œ â€“ ×ª×•×ª×—×™×ª! ğŸŒŸ"],
  "××¢×™×™×Ÿ": ["××¢×™×™×Ÿ, ×¢×‘×•×“×” ××•×©×œ××ª! ğŸ’š","××™×–×• ××œ×•×¤×” ××ª! ×”××©×™×›×™ ×›×š ğŸ˜Š","××¢×™×™×Ÿ â€“ ×‘×•×! ××©×™××” ×’××•×¨×” ğŸ¯"]
};
function motivate(owner){ const a=MOTIVATION[owner]||["×›×œ ×”×›×‘×•×“!"]; toast(a[Math.floor(Math.random()*a.length)]); }

/* ×˜×™×™××¨×™× ×œ××©×™××•×ª */
const timers = {}; // {id:{remain, iv, running}}

function renderDaily(){
  document.getElementById('today-badge').textContent =
    new Date().toLocaleDateString('he-IL',{weekday:'long', day:'2-digit', month:'2-digit'});

  const state = loadDailyState();
  const todays = todaysTasks();

  todays.forEach(t=>{ if(!state.items[t.id]) state.items[t.id]={status:'pending', owner:t.owner, area:t.area, ts:Date.now()}; });
  saveDailyState(state);

  const container = document.getElementById('daily-list');
  container.innerHTML = todays.map(t=>{
    const s = state.items[t.id].status;
    const timer = timers[t.id]?.remain ?? (t.minutes*60);
    const mm = String(Math.floor(timer/60)).padStart(2,'0');
    const ss = String(timer%60).padStart(2,'0');
    return `
      <div class="p-4 rounded-xl border border-gray-100 flex items-start justify-between gap-3">
        <div class="flex-1">
          <div class="flex items-center gap-2">
            <span class="text-2xl">${t.icon}</span>
            <h3 class="font-semibold">${t.title}</h3>
            <span class="badge">${t.minutes} ×“×³</span>
            <span class="badge">${t.owner}</span>
            <span class="badge">${t.area}</span>
          </div>
          <a class="link text-sm" target="_blank" href="${t.video}">ğŸ¥ ×¡×¨×˜×•×Ÿ ×˜×™×¤×™×</a>
          <div class="mt-2 text-sm">â±ï¸ <b id="tm-${t.id}">${mm}:${ss}</b>
            <button class="btn btn-ghost text-xs" data-timer="start" data-id="${t.id}">×”×ª×—×œ</button>
            <button class="btn btn-ghost text-xs" data-timer="pause" data-id="${t.id}">×”×¤×¡×§</button>
            <button class="btn btn-ghost text-xs" data-timer="reset" data-id="${t.id}">××¤×¡</button>
          </div>
        </div>
        <div class="flex flex-col gap-2">
          <button data-act="done" data-id="${t.id}" class="btn ${s==='done'?'btn-gold':'btn-ghost'}">${s==='done'?'×‘×•×¦×¢ âœ…':'×‘×•×¦×¢'}</button>
          <button data-act="skip" data-id="${t.id}" class="btn btn-ghost">×“×œ×’ â­ï¸</button>
          <button data-act="tomorrow" data-id="${t.id}" class="btn btn-ghost">×“×—×” ×œ××—×¨ ğŸ“…</button>
        </div>
      </div>`;
  }).join('');

  // ×¤×¢×•×œ×•×ª ×¡×˜×˜×•×¡ + × ×§×•×“×•×ª + ×¤×¨×¡×™× + ××•×˜×™×‘×¦×™×”
  container.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const id=btn.dataset.id, act=btn.dataset.act;
      const st=loadDailyState(); if(!st.items[id]) return;
      const prev = st.items[id].status;

      if(act==='done') st.items[id].status = (st.items[id].status==='done'?'pending':'done');
      if(act==='skip') st.items[id].status = 'skipped';
      if(act==='tomorrow') st.items[id].status = 'skipped';
      st.items[id].ts = Date.now();
      saveDailyState(st);

      // × ×§×•×“×•×ª ×œ×‘× ×•×ª + ×¤×¨×¡×™ ×™×¢×“ + ×”×•×“×¢×ª ××•×˜×™×‘×¦×™×”
      const owner = st.items[id].owner;
      if(owner==='××¤×œ' || owner==='××¢×™×™×Ÿ'){
        const pts = loadPoints();
        const prevVal = owner==='××¤×œ' ? pts.mafal : pts.maayan;

        if(prev!=='done' && st.items[id].status==='done'){ // ×”×•×¡×¤×ª × ×§×³
          if(owner==='××¤×œ') pts.mafal += 1; else pts.maayan += 1;
          motivate(owner);
          checkRewards(owner, prevVal, owner==='××¤×œ'? pts.mafal : pts.maayan);
        }else if(prev==='done' && st.items[id].status!=='done'){ // ×”×•×¨×“×ª × ×§×³
          if(owner==='××¤×œ') pts.mafal = Math.max(0, pts.mafal-1); else pts.maayan = Math.max(0, pts.maayan-1);
        }
        savePoints(pts);
      }

      renderDaily(); renderDashboard(); renderPointsHistory(); toast('×¢×•×“×›×Ÿ âœ…');
    });
  });

  // ×˜×™×™××¨×™×
  container.querySelectorAll('button[data-timer]').forEach(b=>{
    b.onclick=()=>{
      const id=b.dataset.id, op=b.dataset.timer;
      const defMins = todays.find(x=>x.id===id)?.minutes || 10;
      if(!timers[id]) timers[id]={remain:defMins*60, iv:null, running:false};
      const lbl=document.getElementById('tm-'+id);
      const tick=()=>{
        if(timers[id].remain<=0){ clearInterval(timers[id].iv); timers[id].running=false; try{navigator.vibrate&&navigator.vibrate(200);}catch(e){}; fireNotification(); toast('×”×˜×™×™××¨ ×”×¡×ª×™×™×!'); return;}
        timers[id].remain--; const r=timers[id].remain; lbl.textContent=String(Math.floor(r/60)).padStart(2,'0')+':'+String(r%60).padStart(2,'0');
      };
      if(op==='start' && !timers[id].running){ timers[id].iv=setInterval(tick,1000); timers[id].running=true; }
      if(op==='pause' && timers[id].running){ clearInterval(timers[id].iv); timers[id].running=false; }
      if(op==='reset'){ clearInterval(timers[id].iv); timers[id].remain=defMins*60; timers[id].running=false; const r=timers[id].remain; lbl.textContent=String(Math.floor(r/60)).padStart(2,'0')+':'+String(r%60).padStart(2,'0'); }
    };
  });
}

/* ===================== ×¡×•×¤×´×© (××©×™××” ××•×¨×›×‘×ª ×œ×¡×˜×¤× ×™) ===================== */
const weekendPool = [
  { id:'wardrobe',  icon:'ğŸ‘—', title:'××¨×•×Ÿ ×‘×’×“×™× â€“ ××“×£ ××—×“', area:'×—×“×¨ ××¨×•× ×•×ª', video:'https://www.youtube.com/results?search_query=%D7%A1%D7%99%D7%93%D7%95%D7%A8+%D7%90%D7%A8%D7%95%D7%9F+%D7%91%D7%92%D7%93%D7%99%D7%9D' },
  { id:'kitchencab',icon:'ğŸ—„ï¸', title:'××¨×•×Ÿ ××˜×‘×— â€“ ×ª×‘×œ×™× ×™×',  area:'××˜×‘×—',       video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%90%D7%A8%D7%95%D7%9F+%D7%9E%D7%98%D7%91%D7%97' },
  { id:'utility',   icon:'ğŸ§°', title:'×—×“×¨ ×©×™×¨×•×ª â€“ ×¡×œ ××—×“',    area:'××¨×¤×¡×ª ×©×™×¨×•×ª', video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%97%D7%93%D7%A8+%D7%A9%D7%99%D7%A8%D7%95%D7%AA' },
  { id:'kids-shelf',icon:'ğŸ§¸', title:'××“×£ ×¦×¢×¦×•×¢×™× â€“ ×¡×™×“×•×¨',    area:'×—×“×¨ ××©×—×§×™×',  video:'https://www.youtube.com/results?search_query=%D7%90%D7%A8%D7%92%D7%95%D7%9F+%D7%97%D7%93%D7%A8+%D7%9E%D7%A9%D7%97%D7%A7%D7%99%D7%9D' },
];

function loadWeekly(){ return JSON.parse(localStorage.getItem(STORE.weekly) || "{}"); }
function saveWeekly(m){ localStorage.setItem(STORE.weekly, JSON.stringify(m)); }

function renderWeekly(){
  const wrap=document.getElementById('weekly-card');
  if(!isWeekend()){ wrap.innerHTML='<p class="text-sm text-gray-500">×‘×¡×•×¤×´×© ×ª×•×¤×™×¢ ×›××Ÿ ××©×™××” ××—×ª ×’×“×•×œ×” ğŸ™‚</p>'; return; }
  const [task]=seedPick(weekendPool,1);
  const wk=weekKey(); const st=loadWeekly();
  const done = st[wk]===task.id;
  wrap.innerHTML=`
    <div class="p-4 rounded-xl border border-gray-100 flex items-start justify-between gap-3">
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <span class="text-2xl">${task.icon}</span>
          <h3 class="font-semibold">${task.title}</h3>
          <span class="badge">${task.area}</span>
        </div>
        <a class="link text-sm" target="_blank" href="${task.video}">ğŸ¬ ×¡×¨×˜×•×Ÿ ×”×©×¨××”</a>
      </div>
      <div class="flex flex-col gap-2">
        <button id="btn-weekly-done" class="btn ${done?'btn-gold':'btn-ghost'}">${done?'×‘×•×¦×¢ âœ…':'×‘×•×¦×¢'}</button>
        <button id="btn-skip-week" class="btn btn-ghost">×“×œ×’ ×œ×©×‘×•×¢ ×”×‘× â­ï¸</button>
      </div>
    </div>`;
  document.getElementById('btn-weekly-done').onclick=()=>{ const m=loadWeekly(); m[wk]=done?null:task.id; saveWeekly(m); renderWeekly(); renderDashboard(); toast('×¢×•×“×›×Ÿ âœ…'); };
  document.getElementById('btn-skip-week').onclick=()=>{ const m=loadWeekly(); m[wk]=task.id; saveWeekly(m); location.reload(); };
}

/* ===================== ×¦×³×§Ö¾×œ×™×¡×˜ ××–×•×¨×™ (×©×œ×š) ===================== */
function loadAreaCL(){ return JSON.parse(localStorage.getItem(STORE.areaCL) || "[]"); }
function saveAreaCL(list){ localStorage.setItem(STORE.areaCL, JSON.stringify(list)); }

function buildChecklistFromText(){
  const text=document.getElementById('steps-input').value.trim();
  const area=document.getElementById('area-select').value;
  if(!text) return toast('××™×Ÿ ×¦×¢×“×™× ×œ×”×•×¡×™×£');
  const list=loadAreaCL();
  const lines=text.split('\n').map(s=>s.trim()).filter(Boolean);
  lines.forEach((t,i)=> list.push({id:'a'+Date.now()+i, text:t, done:false, area, ts:Date.now()}));
  saveAreaCL(list);
  renderChecklist(true); renderDashboard(); toast('× ×•×¦×¨ ×¦×³×§Ö¾×œ×™×¡×˜ âœ…');
}
function renderChecklist(showAll=false){
  const container=document.getElementById('checklist');
  const data=loadAreaCL();
  const visible=showAll?data:data.filter(x=>!x.done);
  container.innerHTML = visible.length ? visible.map(it=>`
    <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-100">
      <input type="checkbox" ${it.done?'checked':''} data-id="${it.id}" class="h-5 w-5 rounded">
      <span class="${it.done?'line-through text-gray-400':''}">${it.text} <span class="badge">${it.area}</span></span>
    </label>
  `).join('') : `<p class="text-sm text-gray-500">××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×¦×’×”.</p>`;
  container.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change',()=>{
      const id=cb.dataset.id; const list=loadAreaCL(); const it=list.find(x=>x.id===id); if(!it) return;
      it.done=cb.checked; it.ts=Date.now(); saveAreaCL(list); renderChecklist(showAll); renderDashboard();
    });
  });
}
document.getElementById('btn-build-checklist').onclick=buildChecklistFromText;
document.getElementById('btn-hide-done').onclick=()=>renderChecklist(false);
document.getElementById('btn-show-all').onclick=()=>renderChecklist(true);
document.getElementById('btn-clear').onclick=()=>{ if(confirm('×œ× ×§×•×ª ××ª ×”×¦×³×§Ö¾×œ×™×¡×˜?')){ saveAreaCL([]); renderChecklist(true); renderDashboard(); } };

/* ===================== ×ª×›× ×™×ª ×—×•×“×©×™×ª ×œ×¤×™ ××–×•×¨ â€“ UI ===================== */
function openMonthlyArea(area){
  const modal=document.getElementById('list-modal');
  const title=document.getElementById('modal-title');
  const body=document.getElementById('modal-body');
  title.textContent="×ª×›× ×™×ª ×—×•×“×©×™×ª â€“ "+area;
  const plan=AREA_PLAN[area]||[];
  const st=loadPlan(); const doneSet=new Set(Object.keys(st.done?.[area]||{}));

  body.innerHTML = plan.length ? plan.map(it=>{
    const checked = doneSet.has(it.id);
    const vid = it.video? `<a class="link text-sm" target="_blank" href="${it.video}">ğŸ¥</a>` : '';
    return `<label class="flex items-center gap-3 p-3 rounded-xl border">
      <input type="checkbox" ${checked?'checked':''} data-area="${area}" data-id="${it.id}">
      <span>${it.text} ${vid}</span>
    </label>`;
  }).join('') : '<p class="text-sm text-gray-500">××™×Ÿ ××©×™××•×ª ××•×’×“×¨×•×ª ×œ××–×•×¨ ×–×”.</p>';

  body.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.addEventListener('change',()=>{
      const a=cb.dataset.area, id=cb.dataset.id;
      const st=loadPlan(); st.done=st.done||{}; st.done[a]=st.done[a]||{};
      if(cb.checked) st.done[a][id]=Date.now(); else delete st.done[a][id];
      savePlan(st); renderDashboard();
    });
  });

  modal.showModal();
}
document.getElementById('btn-plan-open').onclick=()=>{
  const area=document.getElementById('plan-area-select').value;
  openMonthlyArea(area);
};

/* ===================== ×“×©×‘×•×¨×“ ===================== */
function renderDashboard(){
  // ×™×•××™
  const st=loadDailyState();
  const todays = todaysTasks();
  const ids = todays.map(t=>t.id);
  let pending=0, skipped=0, done=0;
  ids.forEach(id=>{
    const rec=st.items[id]; if(!rec) return;
    if(rec.status==='pending') pending++;
    if(rec.status==='skipped') skipped++;
    if(rec.status==='done' && monthKey(rec.ts)===monthKey()) done++;
  });
  document.getElementById('stat-pending').textContent=pending;
  document.getElementById('stat-skipped').textContent=skipped;
  document.getElementById('stat-done').textContent=done;

  // × ×§×•×“×•×ª ×©×‘×•×¢×™×•×ª (×‘× ×•×ª)
  const pts=loadPoints();
  document.getElementById('pts-mafal').textContent=pts.mafal||0;
  document.getElementById('pts-maayan').textContent=pts.maayan||0;

  // ×”×ª×§×“××•×ª ×—×•×“×©×™×ª ×œ×¤×™ ××–×•×¨
  const plan = loadPlan();
  const cl = loadAreaCL();
  const mk = monthKey();
  const wrap=document.getElementById('areas-progress');

  wrap.innerHTML = AREAS.map(a=>{
    const planTotal = (AREA_PLAN[a]||[]).length;
    const planDone  = Object.keys((plan.done?.[a])||{}).length;

    const clMonthAll = cl.filter(x=>x.area===a && monthKey(x.ts)===mk);
    const clMonthTotal = clMonthAll.length;
    const clMonthDone  = clMonthAll.filter(x=>x.done).length;

    const num = planDone + clMonthDone;
    const den = planTotal + clMonthTotal;
    const pct = den? Math.round(num*100/den) : 0;

    return `
      <button data-area="${a}" class="w-full text-left">
        <div class="flex items-center justify-between">
          <b>${a}</b>
          <span class="text-sm text-gray-500">${pct}% (${num}/${den})</span>
        </div>
        <div class="progress-wrap mt-2"><div class="progress-bar" style="width:${pct}%"></div></div>
      </button>`;
  }).join('');

  // ×¤×ª×™×—×ª ×¨×©×™××•×ª
  document.querySelectorAll('[data-open]').forEach(btn=>{
    btn.onclick = ()=> openList(btn.getAttribute('data-open'));
  });
  wrap.querySelectorAll('button[data-area]').forEach(b=>{
    b.onclick=()=> openMonthlyArea(b.getAttribute('data-area'));
  });
}

function openList(key){
  const modal=document.getElementById('list-modal');
  const title=document.getElementById('modal-title');
  const body=document.getElementById('modal-body');
  const st=loadDailyState();
  const picked=todaysTasks();
  let filt=[];
  if(key==='pending') filt=picked.filter(t=>st.items[t.id]?.status==='pending');
  if(key==='skipped') filt=picked.filter(t=>st.items[t.id]?.status==='skipped');
  if(key==='done')    filt=picked.filter(t=>st.items[t.id]?.status==='done' && monthKey(st.items[t.id].ts)===monthKey());
  if(key.startsWith('owner:')){ const who=key.split(':')[1]; filt=picked.filter(t=>st.items[t.id] && t.owner===who && st.items[t.id].status==='done' && monthKey(st.items[t.id].ts)===monthKey()); }
  title.textContent="×¨×©×™××ª ××©×™××•×ª â€“ " + key;
  body.innerHTML = filt.length? filt.map(t=>{
    const s=st.items[t.id].status; const badge = s==='done'?'âœ… ×‘×•×¦×¢':(s==='skipped'?'â­ï¸ ×“×•×œ×’':'â³ ×××ª×™×Ÿ');
    return `<div class="p-3 rounded-xl border"><div class="flex items-center gap-2"><span class="text-xl">${t.icon}</span><b>${t.title}</b><span class="badge">${t.owner}</span><span class="badge">${t.area}</span></div><div class="text-sm text-gray-500 mt-1">${badge}</div></div>`;
  }).join('') : '<p class="text-sm text-gray-500">××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×¦×’×”.</p>';
  modal.showModal();
}

/* ===================== ×”×™×¡×˜×•×¨×™×™×ª × ×§×•×“×•×ª (×“×©×‘×•×¨×“) ===================== */
function renderPointsHistory(){
  const hist = loadHistory();
  const tbody = document.getElementById('points-history-body');
  if(!tbody) return;
  tbody.innerHTML = hist.length ? hist.map(row=>{
    const medal = (row.rewards||[]).map(r=>`${r.owner}: ${r.milestone} × ×§×³`).join(' â€¢ ');
    return `<tr class="border-t">
      <td class="p-2">${row.week}</td>
      <td class="p-2">${row.mafal}</td>
      <td class="p-2">${row.maayan}</td>
      <td class="p-2">${row.total}</td>
      <td class="p-2 text-gray-600">${medal || '-'}</td>
    </tr>`;
  }).join('') : `<tr><td colspan="5" class="p-3 text-gray-500">××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×¡×˜×•×¨×™×”. ×›×©×™×ª×—×œ×£ ×”×©×‘×•×¢ â€“ ×–×” ×™×ª××œ× ××•×˜×•××˜×™×ª.</td></tr>`;
}

/* ===================== ×”×ª×¨××•×ª ===================== */
function updateNotifyUI(){
  const on = JSON.parse(localStorage.getItem(STORE.notify)||"false");
  document.getElementById('notify-status').textContent = on? "×”×ª×–×›×•×¨×ª ×¤×¢×™×œ×”":"×”×ª×–×›×•×¨×ª ×›×‘×•×™×”";
  document.getElementById('btn-notify-toggle').textContent = on? "×›×‘×” ×ª×–×›×•×¨×ª":"×”×¤×¢×œ ×ª×–×›×•×¨×ª";
}
async function enableNotifications(){
  if(!("Notification" in window)){ toast("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª"); return; }
  let p=Notification.permission; if(p==="default") p=await Notification.requestPermission();
  if(p!=="granted"){ toast("×¦×¨×™×š ×œ××©×¨ ×§×‘×œ×ª ×”×ª×¨××•×ª ×‘×“×¤×“×¤×Ÿ"); return; }
  localStorage.setItem(STORE.notify,"true"); scheduleDailyNotification(); updateNotifyUI(); toast("×ª×–×›×•×¨×ª ×”×•×¤×¢×œ×”");
}
function disableNotifications(){ localStorage.setItem(STORE.notify,"false"); clearExistingTimers(); updateNotifyUI(); toast("×ª×–×›×•×¨×ª ×›×•×‘×ª×”"); }
let notifyTimer=null;
function clearExistingTimers(){ if(notifyTimer) clearTimeout(notifyTimer); notifyTimer=null; }
function scheduleDailyNotification(){
  clearExistingTimers();
  const on = JSON.parse(localStorage.getItem(STORE.notify)||"false"); if(!on) return;
  const now=new Date(); const start=new Date(now.getFullYear(),now.getMonth(),now.getDate(),21,0,0); const end=new Date(now.getFullYear(),now.getMonth(),now.getDate(),22,0,0);
  let ms=start-now; if(ms<0){ ms=end-now; if(ms<0) ms=start.getTime()+86400000-now.getTime(); }
  notifyTimer=setTimeout(()=>{ fireNotification(); scheduleDailyNotification(); }, ms);
}
function fireNotification(){
  try{ if("Notification" in window && Notification.permission==="granted"){ new Notification("×–××Ÿ ×œ× ×™×§×™×•×Ÿ! ğŸ ",{body:"×”×’×™×¢ ×”×–××Ÿ ×œ××©×™××•×ª ×”×‘×™×ª ×©×œ×š"}); } }catch(e){}
  toast("×–××Ÿ ×œ× ×™×§×™×•×Ÿ! ğŸ§½");
}
document.getElementById('btn-notify-toggle').onclick=()=>{ JSON.parse(localStorage.getItem(STORE.notify)||"false")? disableNotifications(): enableNotifications(); };
document.getElementById('btn-notify-test').onclick=async ()=>{ if(!("Notification" in window)){ toast("××™×Ÿ ×ª××™×›×” â€“ ×ª×•×¦×’ ×”×ª×¨××” ×¤× ×™××™×ª"); } if(Notification.permission!=="granted"){ await Notification.requestPermission(); } fireNotification(); };

/* ===================== × ×™×•×•×˜ + PWA ===================== */
function route(){
  const hash=location.hash||"#/home";
  document.getElementById('view-home').classList.toggle('hidden', hash!=="#/home");
  document.getElementById('view-dashboard').classList.toggle('hidden', hash!=="#/dashboard");
  document.getElementById('nav-home').classList.toggle('nav-act', hash==="#/home");
  document.getElementById('nav-dash').classList.toggle('nav-act', hash==="#/dashboard");
  if(hash==="#/dashboard"){ renderDashboard(); renderPointsHistory(); }
}
window.addEventListener('hashchange', route);

// PWA: ×¨×™×©×•× SW + install prompt
let deferredPrompt=null;
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('service-worker.js'); });
}
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt=e;
  const btn=document.getElementById('btn-install'); btn.classList.remove('hidden');
  btn.onclick= async ()=>{
    if(!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt=null; btn.classList.add('hidden');
  };
});

/* ===================== Toast ===================== */
function toast(msg){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),2600); }

/* ===================== Init ===================== */
document.addEventListener('DOMContentLoaded', ()=>{
  ensureWeekRollover(); // ×’×œ×’×•×œ ×©×‘×•×¢ -> ×”×™×¡×˜×•×¨×™×”
  route();
  renderDaily(); renderWeekly(); renderChecklist(true); renderDashboard();
  renderPointsHistory();
  updateNotifyUI(); if(JSON.parse(localStorage.getItem(STORE.notify)||"false")) scheduleDailyNotification();
});
</script>
</body>
</html>
