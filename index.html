<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>××¨×’×•×Ÿ ×•×¡×“×¨ â€“ ×¡×˜×¤× ×™</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/svg+xml" href="icons/favicon.svg">
<meta name="theme-color" content="#b08d57">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;600;800&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

<style>
  :root{--gold:#b08d57;--ink:#1c1b1a;--card:#ffffff}
  body{font-family:'Heebo',sans-serif;background:linear-gradient(180deg,#fffdf8,#faf7ff)}
  h1,h2,h3{font-family:'Playfair Display',serif}
  .card{background:var(--card);border-radius:18px;box-shadow:0 12px 30px rgba(0,0,0,.08);border:1px solid rgba(176,141,87,.15)}
  .badge{background:#fff3d9;color:#6b4b1d;border:1px solid rgba(176,141,87,.35);border-radius:999px;padding:.15rem .6rem;font-size:.8rem}
  .btn{border-radius:12px;padding:.55rem .9rem;border:1px solid rgba(28,27,26,.08)}
  .btn-ghost{background:#f8f6ff}
  .btn-gold{background:var(--gold);color:#fff}
  .link{color:#6d28d9;text-decoration:underline}
  .nav-act{color:#fff;background:var(--gold)}
  .toast{position:fixed;inset-inline:16px;top:16px;background:var(--gold);color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.2);z-index:9999;text-align:center}
  .progress-wrap{height:8px;background:#f3f4f6;border-radius:999px}
  .progress-bar{height:8px;background:var(--gold);border-radius:999px}
  dialog::backdrop{background:rgba(0,0,0,.4)}
</style>
</head>
<body class="min-h-screen text-[15px]">

  <!-- NAV -->
  <nav class="sticky top-0 z-50 bg-white/80 backdrop-blur border-b border-[rgba(176,141,87,.25)]">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-2 justify-between">
      <div class="flex items-center gap-2">
        <span class="text-2xl">ğŸ </span>
        <b class="text-lg">××¨×’×•×Ÿ ×•×¡×“×¨</b>
      </div>
      <div class="flex gap-2">
        <a href="#/home" id="nav-home" class="btn btn-ghost">×‘×™×ª</a>
        <a href="#/dashboard" id="nav-dash" class="btn btn-ghost">×“×©×‘×•×¨×“</a>
        <button id="btn-install" class="btn btn-ghost hidden">×”×ª×§×Ÿ ××¤×œ×™×§×¦×™×” ğŸ“²</button>
      </div>
    </div>
  </nav>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">

    <!-- FAMILY SHARE -->
    <div class="card p-4">
      <div class="flex items-center justify-between gap-2">
        <div>
          <b>ğŸ”— ×§×™×©×•×¨ ××©×¤×—×ª×™ ××©×•×ª×£</b>
          <p class="text-sm text-gray-500">×¤×ª×—×™ ×•×©×™×ª×¤×™ ××ª ×”-URL ×”×–×” ×›×“×™ ×©×›×•×œ×›× ×ª×¨××• ××•×ª×• ××¦×‘.</p>
        </div>
        <button id="btn-copy-link" class="btn btn-gold text-sm">×”×¢×ª×§ ×§×™×©×•×¨</button>
      </div>
      <input id="shared-url" class="mt-2 w-full border rounded-lg p-2 text-sm" readonly>
    </div>

    <!-- ====== HOME ====== -->
    <section id="view-home" class="space-y-6">

      <!-- ×”×ª×¨××•×ª -->
      <div class="card p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-xl">ğŸ”” ×ª×–×›×•×¨×ª ×™×•××™×ª</h2>
            <p class="text-sm text-gray-500">×”×ª×¨××” ×‘×™×Ÿ 21:00â€“22:00 (×œ×•×§××œ×™ ×‘××›×©×™×¨; ×¢×“×™×™×Ÿ ×¢×•×‘×“ ×’× ×¢× ×¡× ×›×¨×•×Ÿ).</p>
          </div>
          <div class="flex gap-2">
            <button id="btn-notify-toggle" class="btn btn-ghost">×”×¤×¢×œ ×ª×–×›×•×¨×ª</button>
            <button id="btn-notify-test" class="btn btn-gold">×‘×“×™×§×ª ×ª×–×›×•×¨×ª</button>
          </div>
        </div>
        <p id="notify-status" class="text-sm text-gray-500 mt-2"></p>
      </div>

      <!-- ××©×™××•×ª ×™×•××™×•×ª (× ×‘× ×” ××•×˜×•××˜×™×ª ××ª×•×š ×œ×•×—-×—×•×“×©) -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl">ğŸ¯ ×¤×•×§×•×¡ ×™×•××™</h2>
          <span id="today-badge" class="badge"></span>
        </div>
        <p class="text-sm text-gray-500 mt-1">
          ××³â€“×”×³: 2 ×œ××¤×œ â€¢ 2 ×œ××¢×™×™×Ÿ â€¢ 2 ×œ×¡×˜×¤× ×™ (5â€“15 ×“×³ ×œ××©×™××”) | ×•×³â€“×©×³: 1 ×œ××¤×œ â€¢ 1 ×œ××¢×™×™×Ÿ + ××©×™××” ××•×¨×›×‘×ª ×œ×¡×˜×¤× ×™
        </p>
        <div id="daily-list" class="mt-4 grid gap-3"></div>
      </div>

      <!-- ××•×¨×›×‘×•×ª ×œ×¡×•×¤"×© â€“ ×œ×¡×˜×¤× ×™ -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl">ğŸ§± ××•×¨×›×‘×•×ª ×œ×¡×•×¤×´×© (×œ×¡×˜×¤× ×™)</h2>
          <span class="badge">30â€“60 ×“×³</span>
        </div>
        <div id="weekly-card" class="mt-4"></div>
      </div>

      <!-- ×ª×›× ×™×ª ×××•×§×“×ª ×œ××–×•×¨ (×¦×³×§Ö¾×œ×™×¡×˜) -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl">ğŸ“Œ ×ª×›× ×™×ª ×××•×§×“×ª ×œ××–×•×¨ (×¦×³×§Ö¾×œ×™×¡×˜)</h2>
          <button id="btn-show-all" class="btn btn-ghost text-sm">×”×¦×’ ×”×›×•×œ ğŸ‘€</button>
        </div>

        <div class="grid md:grid-cols-3 gap-3 mt-3">
          <div class="md:col-span-2">
            <p class="text-sm text-gray-500">×”×“×‘×™×§×™ ×›××Ÿ ×¦×¢×“×™× â€“ ×›×œ ×©×•×¨×” ×¡×¢×™×£:</p>
            <textarea id="steps-input" rows="5" class="w-full mt-2 rounded-xl border border-gray-200 p-3" placeholder="1. ×œ××¡×•×£ × ×¢×œ×™×™×&#10;2. ×œ×¨×•×§×Ÿ ××ª ×”×©×•×œ×—×Ÿ&#10;3. ×œ××™×™×Ÿ ×›×‘×™×¡×”"></textarea>
          </div>
          <div>
            <label class="text-sm">×©×™×•×š ×œ××–×•×¨:</label>
            <select id="area-select" class="w-full mt-2 rounded-xl border border-gray-200 p-3">
              <option>×¡×œ×•×Ÿ</option><option>××˜×‘×—</option><option>××™</option><option>××¨×¤×¡×ª ×©×™×¨×•×ª</option><option>×—×“×¨ ××©×—×§×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª</option><option>×—×“×¨ ×©×™× ×” ×™×œ×“×™×</option><option>×—×“×¨ ××¨×•× ×•×ª</option><option>×—×“×¨ ×©×™× ×” ×”×•×¨×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×</option><option>×—×¦×¨ ×§×“××™×ª</option><option>×—×¦×¨ ××—×•×¨×™×ª</option>
            </select>
            <div class="flex flex-wrap gap-2 mt-3">
              <button id="btn-build-checklist" class="btn btn-gold">×¦×•×¨/×¢×“×›×Ÿ ×¦×³×§Ö¾×œ×™×¡×˜ âœ…</button>
              <button id="btn-hide-done" class="btn btn-ghost">×”×¡×ª×¨ ×©×”×•×©×œ× ğŸ§¹</button>
              <button id="btn-clear" class="btn btn-ghost">× ×§×” ×¦×³×§Ö¾×œ×™×¡×˜ ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>
        <div id="checklist" class="mt-4 space-y-2"></div>
        <p class="text-sm text-gray-500 mt-2">×¡×¢×™×¤×™× ××¡×•×× ×™× × ×¡×¤×¨×™× ×œ×”×ª×§×“××•×ª ×”××–×•×¨ **×”×—×•×“×©×™×ª**.</p>
      </div>

      <!-- ×ª×›× ×™×ª ×—×•×“×©×™×ª ×œ×¤×™ ××–×•×¨ -->
      <div class="card p-5">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl">ğŸ“… ×ª×›× ×™×ª ×—×•×“×©×™×ª â€“ ×œ×¤×™ ××–×•×¨</h2>
          <div class="flex gap-2 items-center">
            <select id="plan-area-select" class="rounded-xl border border-gray-200 p-2">
              <option>×¡×œ×•×Ÿ</option><option>××˜×‘×—</option><option>××™</option><option>××¨×¤×¡×ª ×©×™×¨×•×ª</option><option>×—×“×¨ ××©×—×§×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª</option><option>×—×“×¨ ×©×™× ×” ×™×œ×“×™×</option><option>×—×“×¨ ××¨×•× ×•×ª</option><option>×—×“×¨ ×©×™× ×” ×”×•×¨×™×</option><option>×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×</option><option>×—×¦×¨ ×§×“××™×ª</option><option>×—×¦×¨ ××—×•×¨×™×ª</option>
            </select>
            <button id="btn-plan-open" class="btn btn-ghost">×¤×ª×— ×¨×©×™××ª ××–×•×¨ âœ¨</button>
          </div>
        </div>
        <p class="text-sm text-gray-500 mt-2">×›×•×œ×œ â€œ× ×™×§×•×™ ×¡×¤×•×ªâ€ + â€œ×—×œ×•× ×•×ª/××¡×™×œ×•×ªâ€.</p>
      </div>
    </section>

    <!-- ====== DASHBOARD ====== -->
    <section id="view-dashboard" class="space-y-6 hidden">
      <div class="grid md:grid-cols-3 gap-4">
        <!-- ×‘× ×™×™×Ÿ 1 -->
        <div class="card p-5">
          <h3 class="text-xl">ğŸ—ï¸ ×‘× ×™×™×Ÿ 1 â€“ ××¦×‘ ××©×™××•×ª (×”×™×•×)</h3>
          <div class="mt-3 space-y-2">
            <button data-open="pending" class="w-full btn btn-ghost flex justify-between"><span>×©×˜×¨× ×˜×•×¤×œ×•</span><b id="stat-pending">0</b></button>
            <button data-open="skipped" class="w-full btn btn-ghost flex justify-between"><span>×©×“×™×œ×’×ª×™</span><b id="stat-skipped">0</b></button>
            <button data-open="done" class="w-full btn btn-ghost flex justify-between"><span>×©×”×•×©×œ××• (×”×—×•×“×©)</span><b id="stat-done">0</b></button>
          </div>
        </div>

        <!-- ×‘× ×™×™×Ÿ 2 -->
        <div class="card p-5">
          <h3 class="text-xl">ğŸ‘­ ×‘× ×™×™×Ÿ 2 â€“ ×”×‘× ×•×ª: × ×§×•×“×•×ª ×”×©×‘×•×¢</h3>
          <div class="mt-3 space-y-2">
            <div class="flex items-center justify-between">
              <span>××¤×œ</span><b id="pts-mafal">0</b>
            </div>
            <div class="flex items-center justify-between">
              <span>××¢×™×™×Ÿ</span><b id="pts-maayan">0</b>
            </div>
            <p class="text-sm text-gray-500 mt-1">×›×œ â€œ×‘×•×¦×¢â€ ×‘××©×™××ª ×‘×ª = × ×§×•×“×”. ××ª××¤×¡ ×›×œ ×©×‘×•×¢.</p>
          </div>
        </div>

        <!-- ×‘× ×™×™×Ÿ 3 -->
        <div class="card p-5">
          <h3 class="text-xl">ğŸ“ ×‘× ×™×™×Ÿ 3 â€“ ×”×ª×§×“××•×ª ×—×•×“×©×™×ª ×œ×¤×™ ××–×•×¨</h3>
          <div id="areas-progress" class="mt-3 space-y-3"></div>
          <p class="text-sm text-gray-500 mt-2">×”×ª×§×“××•×ª = ×ª×›× ×™×ª ×—×•×“×©×™×ª ×©×¡×•×× ×” + ×¤×¨×™×˜×™ ×¦×³×§Ö¾×œ×™×¡×˜ ××”×—×•×“×©.</p>
        </div>

        <!-- ×‘× ×™×™×Ÿ 4 -->
        <div class="card p-5 md:col-span-3">
          <h3 class="text-xl">ğŸ“… ×”×™×¡×˜×•×¨×™×™×ª × ×§×•×“×•×ª â€“ ×©×‘×•×¢×•×ª ×§×•×“××™×</h3>
          <div id="points-history" class="mt-3 overflow-auto">
            <table class="w-full text-sm">
              <thead>
                <tr class="text-gray-500">
                  <th class="text-right p-2">×©×‘×•×¢</th>
                  <th class="text-right p-2">××¤×œ</th>
                  <th class="text-right p-2">××¢×™×™×Ÿ</th>
                  <th class="text-right p-2">×¡×”×´×›</th>
                  <th class="text-right p-2">×¤×¨×¡×™×</th>
                </tr>
              </thead>
              <tbody id="points-history-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- MODAL -->
  <dialog id="list-modal" class="rounded-2xl p-0 w-[min(92vw,640px)]">
    <div class="p-4 border-b flex items-center justify-between">
      <b id="modal-title">×¨×©×™××”</b>
      <button onclick="document.getElementById('list-modal').close()" class="btn btn-ghost">×¡×’×•×¨</button>
    </div>
    <div id="modal-body" class="p-4 max-h-[70vh] overflow-auto space-y-2"></div>
  </dialog>

<!-- Firebase + ×œ×•×’×™×§×” -->
<script type="module">
/*** ===== Firebase ===== ***/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
import { firebaseConfig } from "./firebase-config.js";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/*** ===== Shared family ID via URL ===== ***/
const qs = new URLSearchParams(location.search);
const FAMILY = (qs.get('family') || localStorage.getItem('family_id') || 'steph-family').trim();
localStorage.setItem('family_id', FAMILY);
document.getElementById('shared-url').value = location.origin + location.pathname + '?family=' + encodeURIComponent(FAMILY);
document.getElementById('btn-copy-link').onclick = async ()=>{
  await navigator.clipboard.writeText(document.getElementById('shared-url').value);
  toast('×”×§×™×©×•×¨ ×”×•×¢×ª×§ âœ…');
};

/*** ===== Collections layout in Firestore =====
 * /families/{FAMILY}/kv/{key} â†’ { value, updatedAt }
 * ×›×œ ×”××©×ª××©×™× (×× ×•× ×™××™×™×) ×©××©×ª××©×™× ×‘××•×ª×• ?family ×¨×•××™× ××•×ª×• ××¦×‘.
 ***********************************************/
const STORE = {
  daily:   "v5_daily_state",
  weekly:  "v3_weekly_state",
  areaCL:  "v3_area_checklist",
  plan:    "v1_area_month_plan",
  notify:  "daily_notify_local", // ×œ×•×§××œ×™ ×‘×œ×‘×“
  points:  "v1_points_week",
  history: "v1_points_history",
  rewards: "v1_rewards",
  monthCal:"v1_month_calendar"   // ×œ×•×—-×—×•×“×© ×©× ×‘× ×” ××•×˜×•××˜×™×ª
};
const path = (key)=> doc(db, "families", FAMILY, "kv", key);

const LOCAL = {
  get:(k,def)=> JSON.parse(localStorage.getItem(k) || JSON.stringify(def)),
  set:(k,v)=> localStorage.setItem(k, JSON.stringify(v))
};
async function cloudGet(key, fallback){
  try{
    const snap = await getDoc(path(key));
    if(snap.exists()){ const data=snap.data().value; LOCAL.set(key,data); return data; }
  }catch(e){}
  return LOCAL.get(key, fallback);
}
async function cloudSet(key, value){
  LOCAL.set(key, value);
  try{
    await setDoc(path(key), { value, updatedAt: serverTimestamp() }, {merge:true});
  }catch(e){}
}
function cloudSubscribe(key, handler){
  try{ return onSnapshot(path(key), (snap)=>{ if(!snap.exists()) return; const v=snap.data().value; if(JSON.stringify(LOCAL.get(key,null))!==JSON.stringify(v)){ LOCAL.set(key,v); handler(v);} }); }
  catch(e){ return ()=>{}; }
}

/*** ===== Helpers ===== ***/
function todayKey(d=new Date()){ return d.toISOString().slice(0,10); }
function monthKey(ts){ const d=ts?new Date(ts):new Date(); return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,'0'); }
function weekKey(){ const d=new Date(); const onejan=new Date(d.getFullYear(),0,1); const w=Math.ceil((((d-onejan)/86400000)+onejan.getDay()+1)/7); return d.getFullYear()+"-W"+String(w).padStart(2,'0'); }
function isWeekend(date=new Date()){ const day=date.getDay(); return (day===5 || day===6); }
function toast(msg){ const el=document.createElement('div'); el.className='toast'; el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),2400); }

/*** ===== Pools ===== ***/
const AREAS=["×¡×œ×•×Ÿ","××˜×‘×—","××™","××¨×¤×¡×ª ×©×™×¨×•×ª","×—×“×¨ ××©×—×§×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª","×—×“×¨ ×©×™× ×” ×™×œ×“×™×","×—×“×¨ ××¨×•× ×•×ª","×—×“×¨ ×©×™× ×” ×”×•×¨×™×","×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×","×—×¦×¨ ×§×“××™×ª","×—×¦×¨ ××—×•×¨×™×ª"];
const poolMafal = [
  { id:'maf_island_pick', icon:'ğŸŸ£', title:'×œ××¡×•×£ ×—×¤×¦×™× ××”××™', owner:'××¤×œ', area:'××™', minutes:5,  video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%90%D7%99+%D7%9E%D7%98%D7%91%D7%97' },
  { id:'maf_table_pick',  icon:'ğŸŸ£', title:'×œ××¡×•×£ ××”×©×•×œ×—×Ÿ ×‘×¡×œ×•×Ÿ', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:5,  video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A9%D7%95%D7%9C%D7%97%D7%9F+%D7%A1%D7%9C%D7%95%D7%9F' },
  { id:'maf_sofa_pick',   icon:'ğŸŸ£', title:'×œ××¡×•×£ ××”×¡×¤×” (×‘×’×“×™×/×¦×¢×¦×•×¢×™×)', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:5,  video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A1%D7%A4%D7%94' },
  { id:'maf_wipe_island', icon:'ğŸ§»', title:'× ×™×’×•×‘ ××”×™×¨ â€“ ××™', owner:'××¤×œ', area:'××™', minutes:7,  video:'https://www.youtube.com/results?search_query=%D7%A0%D7%99%D7%92%D7%95%D7%91+%D7%9E%D7%A9%D7%98%D7%97%D7%99%D7%9D' },
  { id:'maf_broom_living',icon:'ğŸ§¹', title:'×œ×˜××˜× ××ª ×”×¡×œ×•×Ÿ (2 ×“×³)', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:5, video:'https://www.youtube.com/results?search_query=%D7%98%D7%99%D7%90%D7%95%D7%98+%D7%9E%D7%94%D7%99%D7%A8' },
  { id:'maf_cushions',    icon:'ğŸ›‹ï¸', title:'×œ×¡×“×¨ ×›×¨×™×•×ª ×•×©××™×›×” ×‘×¡×¤×”', owner:'××¤×œ', area:'×¡×œ×•×Ÿ', minutes:5, video:'https://www.youtube.com/results?search_query=%D7%A1%D7%93%D7%A8+%D7%A1%D7%9C%D7%95%D7%9F' },
];
const poolMaayan = [
  { id:'may_island_pick', icon:'ğŸŸ¢', title:'×œ××¡×•×£ ×—×¤×¦×™× ××”××™', owner:'××¢×™×™×Ÿ', area:'××™', minutes:5,  video:'', },
  { id:'may_table_pick',  icon:'ğŸŸ¢', title:'×œ××¡×•×£ ××”×©×•×œ×—×Ÿ ×‘×¡×œ×•×Ÿ', owner:'××¢×™×™×Ÿ', area:'×¡×œ×•×Ÿ', minutes:5,  video:'', },
  { id:'may_wipe_island', icon:'ğŸ§»', title:'× ×™×’×•×‘ ××”×™×¨ â€“ ××™', owner:'××¢×™×™×Ÿ', area:'××™', minutes:6,  video:'', },
  { id:'may_broom_living',icon:'ğŸ§¹', title:'×œ×˜××˜× × ×§×•×“×ª×™ ×‘×¡×œ×•×Ÿ', owner:'××¢×™×™×Ÿ', area:'×¡×œ×•×Ÿ', minutes:5, video:'', },
  { id:'may_toys_bin',    icon:'ğŸ§¸', title:'×œ×”×—×–×™×¨ ×¦×¢×¦×•×¢×™× ×œ×¡×œ', owner:'××¢×™×™×Ÿ', area:'×—×“×¨ ××©×—×§×™×', minutes:7, video:'', },
];
const poolSteph = [
  { id:'st_fold10',      icon:'ğŸ§º', title:'×œ×§×¤×œ 10 ×¤×¨×™×˜×™× ×•×œ×”×—×–×™×¨ ×œ××¨×•×Ÿ', owner:'×× ×™', area:'×—×“×¨ ××¨×•× ×•×ª', minutes:12, video:'' },
  { id:'st_paper5',      icon:'ğŸ—‚ï¸', title:'×œ××™×™×Ÿ 5 × ×™×™×¨×•×ª/×“×•××¨', owner:'×× ×™', area:'×¡×œ×•×Ÿ', minutes:10, video:'' },
  { id:'st_bath_sink',   icon:'ğŸš¿', title:'×›×™×•×¨ ×××‘×˜×™×” ××”×™×¨', owner:'×× ×™', area:'×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×', minutes:12, video:'' },
  { id:'st_entry5',      icon:'ğŸšª', title:'×›× ×™×¡×” â€“ 5 ×¤×¨×™×˜×™× ×œ××§×•×', owner:'×× ×™', area:'×¡×œ×•×Ÿ', minutes:10, video:'' },
];
const weekendPool = [
  { id:'wardrobe',  icon:'ğŸ‘—', title:'××¨×•×Ÿ ×‘×’×“×™× â€“ ××“×£ ××—×“', area:'×—×“×¨ ××¨×•× ×•×ª', video:'' },
  { id:'kitchencab',icon:'ğŸ—„ï¸', title:'××¨×•×Ÿ ××˜×‘×— â€“ ×ª×‘×œ×™× ×™×',  area:'××˜×‘×—',       video:'' },
  { id:'utility',   icon:'ğŸ§°', title:'×—×“×¨ ×©×™×¨×•×ª â€“ ×¡×œ ××—×“',    area:'××¨×¤×¡×ª ×©×™×¨×•×ª', video:'' },
  { id:'kids-shelf',icon:'ğŸ§¸', title:'××“×£ ×¦×¢×¦×•×¢×™× â€“ ×¡×™×“×•×¨',    area:'×—×“×¨ ××©×—×§×™×',  video:'' },
];

/*** ===== Monthly Plan (includes sofas/windows rails per area) ===== ***/
const AREA_PLAN = {
  "×¡×œ×•×Ÿ":[
    {id:"lv_sofa_deep",text:"× ×™×§×•×™ ×¡×¤×•×ª â€“ ×©××™×‘×” + ×˜×™×¤×•×œ ×›×ª××™×"},
    {id:"lv_windows",text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×¡×œ×•×Ÿ"},
    {id:"lv_rug",text:"×©×˜×™×— â€“ ×©××™×‘×” ×™×¡×•×“×™×ª"},
    {id:"lv_tv",text:"××“×£/×˜×œ×•×•×™×–×™×” â€“ ××‘×§ ×•×¡×™×“×•×¨"},
  ],
  "××˜×‘×—":[
    {id:"kt_windows",text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ××˜×‘×—"},
    {id:"kt_counters",text:"××©×˜×—×™× â€“ ×¤×™× ×•×™ ×•× ×™×’×•×‘ ×™×¡×•×“×™"},
    {id:"kt_fridge",text:"××§×¨×¨ â€“ ××’×©/××“×£ ××—×“"},
    {id:"kt_spices",text:"××“×£ ×ª×‘×œ×™× ×™× â€“ ××™×•×Ÿ ×•× ×™×’×•×‘"},
  ],
  "××™":[ {id:"island_clear",text:"××™ â€“ ×¤×™× ×•×™ ××œ×, × ×™×’×•×‘, ×”×—×–×¨×”"} ],
  "××¨×¤×¡×ª ×©×™×¨×•×ª":[
    {id:"ut_windows",text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×™×¦×™××” ×œ×—×¦×¨"},
    {id:"ut_bins",text:"××™×•×Ÿ 2 ×¡×œ×™ ××—×¡×•×Ÿ"},
  ],
  "×—×“×¨ ××©×—×§×™×":[
    {id:"pl_windows",text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×—×“×¨ ××©×—×§×™×"},
    {id:"pl_shelf",text:"××“×£ ×¦×¢×¦×•×¢×™× â€“ ×¡×™×“×•×¨ + ×ª×¨×•××”"},
  ],
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ×—×“×¨ ××©×—×§×™×":[
    {id:"bpl_windows",text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×××‘×˜×™×” ××©×—×§×™×"},
    {id:"bpl_sink",text:"×›×™×•×¨/×‘×¨×– â€“ × ×™×§×•×™ ××‘× ×™×ª"},
  ],
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ×‘× ×•×ª":[
    {id:"bg_windows",text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×××‘×˜×™×” ×‘× ×•×ª"},
    {id:"bg_cab",text:"××¨×•×Ÿ â€“ ××“×£ ××—×“"},
  ],
  "×—×“×¨ ×©×™× ×” ×™×œ×“×™×":[
    {id:"kr_windows",text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×—×“×¨ ×™×œ×“×™×"},
    {id:"kr_table",text:"×©×•×œ×—×Ÿ/××“×£ â€“ 10 ×¤×¨×™×˜×™× ×œ××§×•×"},
  ],
  "×—×“×¨ ××¨×•× ×•×ª":[ {id:"cl_shelf",text:"××“×£ ××—×“ â€“ ×§×™×¤×•×œ + ××™×•×Ÿ"} ],
  "×—×“×¨ ×©×™× ×” ×”×•×¨×™×":[
    {id:"pr_windows",text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×—×“×¨ ×”×•×¨×™×"},
    {id:"pr_tables",text:"×©×™×“×•×ª ×œ×™×œ×” â€“ ×¤×™× ×•×™ ×•× ×™×’×•×‘"},
  ],
  "×©×™×¨×•×ª×™×/×××‘×˜×™×” ×”×•×¨×™×":[
    {id:"bp_windows",text:"×—×œ×•× ×•×ª + ××¡×™×œ×•×ª â€“ ×××‘×˜×™×” ×”×•×¨×™×"},
    {id:"bp_glass",text:"×–×›×•×›×™×ª ××§×œ×—×•×Ÿ â€“ × ×™×§×•×™ ×›×ª××™ ××™×"},
  ],
  "×—×¦×¨ ×§×“××™×ª":[ {id:"yd_front",text:"×˜××˜×•× ×•× ×™×§×•×™ ×¤×™× ×ª ×™×©×™×‘×”"} ],
  "×—×¦×¨ ××—×•×¨×™×ª":[ {id:"yd_back",text:"×˜××˜×•× + ××¨×’×•×Ÿ ×¦×¢×¦×•×¢×™ ×—×¦×¨"} ],
};

/*** ===== Month calendar generator =====
 *  ×‘×•× ×” ×œ×•×—-×—×•×“×© (30/31 ×™××™×) ×•××¤×–×¨:
 *  ××³â€“×”×³: 2 ××¤×œ + 2 ××¢×™×™×Ÿ + 2 ×¡×˜×¤× ×™ (×§×¦×¨×•×ª)
 *  ×•×³â€“×©×³: 1 ××¤×œ + 1 ××¢×™×™×Ÿ + ××©×™××” ××•×¨×›×‘×ª
 ******************************************/
function monthDays(date=new Date()){
  const y=date.getFullYear(), m=date.getMonth();
  return new Date(y, m+1, 0).getDate();
}
function seededPick(arr, n, seed){
  const out=[]; let s=seed; const used=new Set();
  while(out.length<n && used.size<arr.length){
    s=(s*1664525+1013904223)>>>0;
    const idx=s%arr.length;
    if(!used.has(idx)){ used.add(idx); out.push(arr[idx]); }
  }
  return out;
}
async function ensureMonthCalendar(){
  const now=new Date();
  const mk=monthKey(now);
  const cal = await cloudGet(STORE.monthCal, {});
  if(cal.month===mk && Array.isArray(cal.days)) return cal; // already built

  const days = monthDays(now);
  const plan = [];
  for(let d=1; d<=days; d++){
    const dt = new Date(now.getFullYear(), now.getMonth(), d);
    const seed = (now.getFullYear()*10000)+((now.getMonth()+1)*100)+d;
    const weekend = isWeekend(dt);
    const maf = seededPick(poolMafal, weekend?1:2, seed+11);
    const may = seededPick(poolMaayan, weekend?1:2, seed+23);
    const st  = seededPick(poolSteph, weekend?0:2, seed+37);
    const wk  = weekend ? seededPick(weekendPool,1, seed+71) : [];
    plan.push({date: todayKey(dt), tasks:[...maf,...may,...st], weekend: wk[0]||null});
  }
  const out = { month: mk, days: plan };
  await cloudSet(STORE.monthCal, out);
  return out;
}

/*** ===== Daily state & points/history ===== ***/
async function loadDailyState(){ return await cloudGet(STORE.daily, {date:todayKey(), items:{}}); }
async function saveDailyState(st){ await cloudSet(STORE.daily, st); }

async function loadWeekly(){ return await cloudGet(STORE.weekly, {}); }
async function saveWeekly(m){ await cloudSet(STORE.weekly, m); }

async function loadAreaCL(){ return await cloudGet(STORE.areaCL, []); }
async function saveAreaCL(v){ await cloudSet(STORE.areaCL, v); }

async function loadPlan(){
  const raw = await cloudGet(STORE.plan, {});
  const mk = monthKey();
  if(raw.month!==mk) return {month:mk, done:{}};
  return raw;
}
async function savePlan(v){ await cloudSet(STORE.plan, v); }

async function loadPoints(){
  const raw = await cloudGet(STORE.points, {});
  const wk = weekKey();
  if(raw.week!==wk) return {week:wk, mafal:0, maayan:0};
  return raw;
}
async function savePoints(v){ await cloudSet(STORE.points, v); }

async function loadHistory(){ return await cloudGet(STORE.history, []); }
async function saveHistory(v){ await cloudSet(STORE.history, v); }
async function pushReward(owner, milestone){
  const list = await cloudGet(STORE.rewards, []);
  list.push({week: weekKey(), owner, milestone, ts: Date.now()});
  await cloudSet(STORE.rewards, list);
}

/*** ===== UI: render daily / weekly ===== ***/
const timers={};
async function renderDaily(){
  document.getElementById('today-badge').textContent =
    new Date().toLocaleDateString('he-IL',{weekday:'long', day:'2-digit', month:'2-digit'});

  const cal = await ensureMonthCalendar();
  const today = todayKey();
  const entry = cal.days.find(d=>d.date===today) || {tasks:[],weekend:null};

  const state = await loadDailyState();
  if(state.date!==today) { state.date=today; state.items={}; }
  entry.tasks.forEach(t=>{ if(!state.items[t.id]) state.items[t.id]={status:'pending', owner:t.owner, area:t.area, ts:Date.now()}; });
  await saveDailyState(state);

  const wrap=document.getElementById('daily-list');
  wrap.innerHTML = entry.tasks.map(t=>{
    const s = state.items[t.id]?.status || 'pending';
    const timer = timers[t.id]?.remain ?? (t.minutes*60);
    const mm = String(Math.floor(timer/60)).padStart(2,'0'), ss=String(timer%60).padStart(2,'0');
    return `<div class="p-4 rounded-xl border border-gray-100 flex items-start justify-between gap-3">
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <span class="text-2xl">${t.icon}</span>
          <h3 class="font-semibold">${t.title}</h3>
          <span class="badge">${t.minutes} ×“×³</span>
          <span class="badge">${t.owner}</span>
          <span class="badge">${t.area}</span>
        </div>
        ${t.video?`<a class="link text-sm" target="_blank" href="${t.video}">ğŸ¥ ×¡×¨×˜×•×Ÿ ×˜×™×¤×™×</a>`:''}
        <div class="mt-2 text-sm">â±ï¸ <b id="tm-${t.id}">${mm}:${ss}</b>
          <button class="btn btn-ghost text-xs" data-timer="start" data-id="${t.id}">×”×ª×—×œ</button>
          <button class="btn btn-ghost text-xs" data-timer="pause" data-id="${t.id}">×”×¤×¡×§</button>
          <button class="btn btn-ghost text-xs" data-timer="reset" data-id="${t.id}">××¤×¡</button>
        </div>
      </div>
      <div class="flex flex-col gap-2">
        <button data-act="done" data-id="${t.id}" class="btn ${s==='done'?'btn-gold':'btn-ghost'}">${s==='done'?'×‘×•×¦×¢ âœ…':'×‘×•×¦×¢'}</button>
        <button data-act="skip" data-id="${t.id}" class="btn btn-ghost">×“×œ×’ â­ï¸</button>
        <button data-act="tomorrow" data-id="${t.id}" class="btn btn-ghost">×“×—×” ×œ××—×¨ ğŸ“…</button>
      </div>
    </div>`;
  }).join('') || `<p class="text-gray-500">××™×Ÿ ××©×™××•×ª ×œ×™×•× ×–×”.</p>`;

  wrap.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.onclick = async ()=>{
      const id=btn.dataset.id, act=btn.dataset.act;
      const st = await loadDailyState();
      const prev = st.items[id]?.status || 'pending';
      if(act==='done') st.items[id].status = (prev==='done'?'pending':'done');
      if(act==='skip') st.items[id].status = 'skipped';
      if(act==='tomorrow') st.items[id].status = 'skipped';
      st.items[id].ts = Date.now();
      await saveDailyState(st);

      // × ×§×•×“×•×ª ×œ×‘× ×•×ª
      const owner = st.items[id].owner;
      if(owner==='××¤×œ' || owner==='××¢×™×™×Ÿ'){
        const pts = await loadPoints();
        const prevVal = owner==='××¤×œ'? pts.mafal : pts.maayan;
        if(prev!=='done' && st.items[id].status==='done'){
          if(owner==='××¤×œ') pts.mafal += 1; else pts.maayan += 1;
          if(prevVal<10 && (owner==='××¤×œ'?pts.mafal:pts.maayan)>=10) await pushReward(owner,10);
          if(prevVal<20 && (owner==='××¤×œ'?pts.mafal:pts.maayan)>=20) await pushReward(owner,20);
        }else if(prev==='done' && st.items[id].status!=='done'){
          if(owner==='××¤×œ') pts.mafal=Math.max(0, pts.mafal-1); else pts.maayan=Math.max(0, pts.maayan-1);
        }
        await savePoints(pts);
      }

      await renderDaily(); await renderDashboard(); toast('×¢×•×“×›×Ÿ âœ…');
    };
  });

  // ×˜×™×™××¨×™×
  wrap.querySelectorAll('button[data-timer]').forEach(b=>{
    b.onclick=()=>{
      const id=b.dataset.id, op=b.dataset.timer;
      const defMins = entry.tasks.find(x=>x.id===id)?.minutes || 10;
      if(!timers[id]) timers[id]={remain:defMins*60, iv:null, running:false};
      const lbl=document.getElementById('tm-'+id);
      const tick=()=>{
        if(timers[id].remain<=0){ clearInterval(timers[id].iv); timers[id].running=false; try{navigator.vibrate&&navigator.vibrate(200);}catch(e){}; fireNotification(); toast('×”×˜×™×™××¨ ×”×¡×ª×™×™×!'); return;}
        timers[id].remain--; const r=timers[id].remain; lbl.textContent=String(Math.floor(r/60)).padStart(2,'0')+':'+String(r%60).padStart(2,'0');
      };
      if(op==='start' && !timers[id].running){ timers[id].iv=setInterval(tick,1000); timers[id].running=true; }
      if(op==='pause' && timers[id].running){ clearInterval(timers[id].iv); timers[id].running=false; }
      if(op==='reset'){ clearInterval(timers[id].iv); timers[id].remain=defMins*60; timers[id].running=false; const r=timers[id].remain; lbl.textContent=String(Math.floor(r/60)).padStart(2,'0')+':'+String(r%60).padStart(2,'0'); }
    };
  });

  renderWeekly(entry.weekend);
}

async function renderWeekly(weekendTask){
  const wrap=document.getElementById('weekly-card');
  if(!isWeekend()) { wrap.innerHTML='<p class="text-sm text-gray-500">×‘×¡×•×¤×´×© ×ª×•×¤×™×¢ ×›××Ÿ ××©×™××” ××—×ª ×’×“×•×œ×” ğŸ™‚</p>'; return; }
  const wkKey = weekKey();
  const st = await loadWeekly();
  const task = weekendTask || weekendPool[0];
  const done = st[wkKey]===task.id;
  wrap.innerHTML = `
    <div class="p-4 rounded-xl border border-gray-100 flex items-start justify-between gap-3">
      <div class="flex-1">
        <div class="flex items-center gap-2">
          <span class="text-2xl">${task.icon}</span>
          <h3 class="font-semibold">${task.title}</h3>
          <span class="badge">${task.area}</span>
        </div>
      </div>
      <div class="flex flex-col gap-2">
        <button id="btn-weekly-done" class="btn ${done?'btn-gold':'btn-ghost'}">${done?'×‘×•×¦×¢ âœ…':'×‘×•×¦×¢'}</button>
        <button id="btn-skip-week" class="btn btn-ghost">×“×œ×’ ×œ×©×‘×•×¢ ×”×‘× â­ï¸</button>
      </div>
    </div>`;
  document.getElementById('btn-weekly-done').onclick = async ()=>{
    const m = await loadWeekly();
    m[wkKey] = done? null : task.id;
    await saveWeekly(m);
    await renderWeekly(task);
    await renderDashboard();
    toast('×¢×•×“×›×Ÿ âœ…');
  };
  document.getElementById('btn-skip-week').onclick = async ()=>{
    const m = await loadWeekly();
    m[wkKey] = task.id;
    await saveWeekly(m);
    location.reload();
  };
}

/*** ===== Checklist (paste) ===== ***/
document.getElementById('btn-build-checklist').onclick = async ()=>{
  const text=document.getElementById('steps-input').value.trim();
  const area=document.getElementById('area-select').value;
  if(!text) return toast('××™×Ÿ ×¦×¢×“×™× ×œ×”×•×¡×™×£');
  const list=await loadAreaCL();
  const lines=text.split('\n').map(s=>s.trim()).filter(Boolean);
  lines.forEach((t,i)=> list.push({id:'a'+Date.now()+i, text:t, done:false, area, ts:Date.now()}));
  await saveAreaCL(list); await renderChecklist(true); await renderDashboard(); toast('× ×•×¦×¨ ×¦×³×§Ö¾×œ×™×¡×˜ âœ…');
};
document.getElementById('btn-hide-done').onclick=()=>renderChecklist(false);
document.getElementById('btn-show-all').onclick=()=>renderChecklist(true);
document.getElementById('btn-clear').onclick=async()=>{ if(confirm('×œ× ×§×•×ª ××ª ×”×¦×³×§Ö¾×œ×™×¡×˜?')){ await saveAreaCL([]); await renderChecklist(true); await renderDashboard(); } };

async function renderChecklist(showAll=false){
  const container=document.getElementById('checklist');
  const data=await loadAreaCL();
  const visible=showAll?data:data.filter(x=>!x.done);
  container.innerHTML = visible.length ? visible.map(it=>`
    <label class="flex items-center gap-3 p-3 rounded-xl border border-gray-100">
      <input type="checkbox" ${it.done?'checked':''} data-id="${it.id}" class="h-5 w-5 rounded">
      <span class="${it.done?'line-through text-gray-400':''}">${it.text} <span class="badge">${it.area}</span></span>
    </label>
  `).join('') : `<p class="text-sm text-gray-500">××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×¦×’×”.</p>`;
  container.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.onchange = async ()=>{
      const id=cb.dataset.id; const list=await loadAreaCL(); const it=list.find(x=>x.id===id); if(!it) return;
      it.done=cb.checked; it.ts=Date.now(); await saveAreaCL(list); await renderChecklist(showAll); await renderDashboard();
    };
  });
}

/*** ===== Monthly plan modal per area ===== ***/
document.getElementById('btn-plan-open').onclick=async ()=>{
  const area=document.getElementById('plan-area-select').value;
  openMonthlyArea(area);
};
async function openMonthlyArea(area){
  const modal=document.getElementById('list-modal');
  const title=document.getElementById('modal-title');
  const body=document.getElementById('modal-body');
  title.textContent="×ª×›× ×™×ª ×—×•×“×©×™×ª â€“ "+area;
  const plan=AREA_PLAN[area]||[];
  const st=await loadPlan(); const doneSet=new Set(Object.keys(st.done?.[area]||{}));

  body.innerHTML = plan.length ? plan.map(it=>{
    const checked = doneSet.has(it.id);
    return `<label class="flex items-center gap-3 p-3 rounded-xl border">
      <input type="checkbox" ${checked?'checked':''} data-area="${area}" data-id="${it.id}">
      <span>${it.text}</span>
    </label>`;
  }).join('') : '<p class="text-sm text-gray-500">××™×Ÿ ××©×™××•×ª ××•×’×“×¨×•×ª ×œ××–×•×¨ ×–×”.</p>';

  body.querySelectorAll('input[type=checkbox]').forEach(cb=>{
    cb.onchange = async ()=>{
      const a=cb.dataset.area, id=cb.dataset.id;
      const st=await loadPlan(); st.done=st.done||{}; st.done[a]=st.done[a]||{};
      if(cb.checked) st.done[a][id]=Date.now(); else delete st.done[a][id];
      await savePlan(st); await renderDashboard();
    };
  });
  modal.showModal();
}

/*** ===== Dashboard ===== ***/
async function renderDashboard(){
  const st=await loadDailyState();
  const cal=await ensureMonthCalendar();
  const today=todayKey();
  const entry=cal.days.find(d=>d.date===today) || {tasks:[]};
  let pending=0, skipped=0, done=0;
  entry.tasks.forEach(t=>{
    const rec=st.items[t.id];
    if(!rec || rec.status==='pending') pending++;
    if(rec && rec.status==='skipped') skipped++;
    if(rec && rec.status==='done') done++;
  });
  document.getElementById('stat-pending').textContent=pending;
  document.getElementById('stat-skipped').textContent=skipped;
  document.getElementById('stat-done').textContent=done;

  const pts=await loadPoints();
  document.getElementById('pts-mafal').textContent=pts.mafal||0;
  document.getElementById('pts-maayan').textContent=pts.maayan||0;

  const plan = await loadPlan();
  const cl = await loadAreaCL();
  const mk = monthKey();

  const wrap=document.getElementById('areas-progress');
  wrap.innerHTML = AREAS.map(a=>{
    const planTotal = (AREA_PLAN[a]||[]).length;
    const planDone  = Object.keys((plan.done?.[a])||{}).length;

    const clMonthAll = cl.filter(x=>x.area===a && monthKey(x.ts)===mk);
    const clMonthTotal = clMonthAll.length;
    const clMonthDone  = clMonthAll.filter(x=>x.done).length;

    const num = planDone + clMonthDone;
    const den = planTotal + clMonthTotal;
    const pct = den? Math.round(num*100/den) : 0;

    return `
      <button data-area="${a}" class="w-full text-left">
        <div class="flex items-center justify-between">
          <b>${a}</b><span class="text-sm text-gray-500">${pct}% (${num}/${den})</span>
        </div>
        <div class="progress-wrap mt-2"><div class="progress-bar" style="width:${pct}%"></div></div>
      </button>`;
  }).join('');
  wrap.querySelectorAll('button[data-area]').forEach(b=> b.onclick=()=> openMonthlyArea(b.getAttribute('data-area')));

  // ×¤×ª×™×—×ª ×¨×©×™××•×ª ×‘× ×™×™×Ÿ 1
  document.querySelectorAll('[data-open]').forEach(btn=>{
    btn.onclick = async ()=>{
      const key=btn.getAttribute('data-open');
      const modal=document.getElementById('list-modal');
      const title=document.getElementById('modal-title');
      const body=document.getElementById('modal-body');
      let filt=[];
      if(key==='pending') filt=entry.tasks.filter(t=>!st.items[t.id] || st.items[t.id].status==='pending');
      if(key==='skipped') filt=entry.tasks.filter(t=>st.items[t.id]?.status==='skipped');
      if(key==='done')    filt=entry.tasks.filter(t=>st.items[t.id]?.status==='done');
      title.textContent="×¨×©×™××ª ××©×™××•×ª â€“ " + key;
      body.innerHTML = filt.length? filt.map(t=>{
        const s=st.items[t.id]?.status || 'pending';
        const badge = s==='done'?'âœ… ×‘×•×¦×¢':(s==='skipped'?'â­ï¸ ×“×•×œ×’':'â³ ×××ª×™×Ÿ');
        return `<div class="p-3 rounded-xl border"><div class="flex items-center gap-2"><span class="text-xl">${t.icon}</span><b>${t.title}</b><span class="badge">${t.owner}</span><span class="badge">${t.area}</span></div><div class="text-sm text-gray-500 mt-1">${badge}</div></div>`;
      }).join('') : '<p class="text-sm text-gray-500">××™×Ÿ ×¤×¨×™×˜×™× ×œ×”×¦×’×”.</p>';
      modal.showModal();
    };
  });

  renderPointsHistory();
}

async function renderPointsHistory(){
  const hist = await loadHistory();
  const tbody = document.getElementById('points-history-body');
  tbody.innerHTML = hist.length ? hist.map(row=>{
    const medal = (row.rewards||[]).map(r=>`${r.owner}: ${r.milestone} × ×§×³`).join(' â€¢ ');
    return `<tr class="border-t">
      <td class="p-2">${row.week}</td>
      <td class="p-2">${row.mafal}</td>
      <td class="p-2">${row.maayan}</td>
      <td class="p-2">${row.total}</td>
      <td class="p-2 text-gray-600">${medal || '-'}</td>
    </tr>`;
  }).join('') : `<tr><td colspan="5" class="p-3 text-gray-500">××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×¡×˜×•×¨×™×”.</td></tr>`;
}

/*** ===== Notifications ===== ***/
function updateNotifyUI(){
  const on = JSON.parse(localStorage.getItem(STORE.notify)||"false");
  document.getElementById('notify-status').textContent = on? "×”×ª×–×›×•×¨×ª ×¤×¢×™×œ×”":"×”×ª×–×›×•×¨×ª ×›×‘×•×™×”";
  document.getElementById('btn-notify-toggle').textContent = on? "×›×‘×” ×ª×–×›×•×¨×ª":"×”×¤×¢×œ ×ª×–×›×•×¨×ª";
}
let notifyTimer=null;
function clearNotify(){ if(notifyTimer) clearTimeout(notifyTimer); notifyTimer=null; }
function scheduleDailyNotification(){
  clearNotify();
  const on = JSON.parse(localStorage.getItem(STORE.notify)||"false"); if(!on) return;
  const now=new Date();
  const start=new Date(now.getFullYear(),now.getMonth(),now.getDate(),21,0,0);
  const end=new Date(now.getFullYear(),now.getMonth(),now.getDate(),22,0,0);
  let ms=start-now; if(ms<0){ ms=end-now; if(ms<0){ ms = (start.getTime()+86400000) - now.getTime(); } }
  notifyTimer=setTimeout(()=>{ fireNotification(); scheduleDailyNotification(); }, ms);
}
function fireNotification(){
  try{ if("Notification" in window && Notification.permission==="granted"){ new Notification("×–××Ÿ ×œ× ×™×§×™×•×Ÿ! ğŸ ",{body:"×”×’×™×¢ ×”×–××Ÿ ×œ××©×™××•×ª ×”×‘×™×ª ×©×œ×š"}); } }catch(e){}
  toast("×–××Ÿ ×œ× ×™×§×™×•×Ÿ! ğŸ§½");
}
document.getElementById('btn-notify-toggle').onclick=async ()=>{
  const cur = JSON.parse(localStorage.getItem(STORE.notify)||"false");
  if(!cur){
    if(!("Notification" in window)){ toast("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª"); return; }
    let p=Notification.permission; if(p==="default") p=await Notification.requestPermission();
    if(p!=="granted"){ toast("×¦×¨×™×š ×œ××©×¨ ×§×‘×œ×ª ×”×ª×¨××•×ª"); return; }
    localStorage.setItem(STORE.notify,"true"); scheduleDailyNotification();
  }else{
    localStorage.setItem(STORE.notify,"false"); clearNotify();
  }
  updateNotifyUI();
};
document.getElementById('btn-notify-test').onclick=async ()=>{ if("Notification" in window && Notification.permission!=="granted"){ await Notification.requestPermission(); } fireNotification(); };

/*** ===== Routing + PWA ===== ***/
function route(){
  const hash=location.hash||"#/home";
  document.getElementById('view-home').classList.toggle('hidden', hash!=="#/home");
  document.getElementById('view-dashboard').classList.toggle('hidden', hash!=="#/dashboard");
  document.getElementById('nav-home').classList.toggle('nav-act', hash==="#/home");
  document.getElementById('nav-dash').classList.toggle('nav-act', hash==="#/dashboard");
  if(hash==="#/dashboard"){ renderDashboard(); }
}
window.addEventListener('hashchange', route);

let deferredPrompt=null;
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('service-worker.js'); });
}
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault(); deferredPrompt=e;
  const btn=document.getElementById('btn-install'); btn.classList.remove('hidden');
  btn.onclick= async ()=>{
    if(!deferredPrompt) return;
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt=null; btn.classList.add('hidden');
  };
});

/*** ===== Weekly rollover (history) ===== ***/
async function appendWeekToHistory(prev){
  if(!prev?.week) return;
  const hist = await loadHistory();
  const rewards = await cloudGet(STORE.rewards, []);
  const row = {week: prev.week, mafal: prev.mafal||0, maayan: prev.maayan||0, total:(prev.mafal||0)+(prev.maayan||0), rewards: rewards.filter(r=>r.week===prev.week)};
  hist.unshift(row);
  await saveHistory(hist);
}
async function ensureWeekRollover(){
  const raw = await cloudGet(STORE.points, {});
  const wk = weekKey();
  if(raw.week && raw.week !== wk){
    await appendWeekToHistory(raw);
    await savePoints({week:wk, mafal:0, maayan:0});
  }else if(!raw.week){
    await savePoints({week:wk, mafal:0, maayan:0});
  }
}

/*** ===== Init ===== ***/
(async function init(){
  await signInAnonymously(auth);
  await ensureWeekRollover();
  route();
  await ensureMonthCalendar();
  await renderDaily();
  await renderChecklist(true);
  await renderDashboard();
  updateNotifyUI();

  // ×¨×™×œ-×˜×™×™×
  cloudSubscribe(STORE.daily,   ()=>{ renderDaily(); renderDashboard(); });
  cloudSubscribe(STORE.monthCal,()=>{ renderDaily(); });
  cloudSubscribe(STORE.areaCL,  ()=>{ renderChecklist(true); renderDashboard(); });
  cloudSubscribe(STORE.plan,    ()=>{ renderDashboard(); });
  cloudSubscribe(STORE.points,  ()=>{ renderDashboard(); });
  cloudSubscribe(STORE.history, ()=>{ renderPointsHistory(); });

})();
</script>
</body>
</html>
